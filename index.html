<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Seasons Ambience</title>
<meta name="description" content="Interactive ambience — choose a season, weather, overlays like a picnic, with god rays, heat haze, and water caustics."/>
<style>
  :root{
    --ui-bg: rgba(20,22,24,.55);
    --ui-blur: 14px;
    --ui-border: rgba(255,255,255,.12);
    --ui-text: #f7f7f7;
    --ui-accent: #91d5ff;
    --ui-muted: #b9c0c7;
    --panel-w: min(420px, 92vw);

    --z-scene: 0;
    --z-canvas: 1;
    --z-overlays: 2;
    --z-sprite: 3;
    --z-hotspots: 4;
    --z-ui: 5;
    --z-overlay: 6;

    /* Parallax offsets (updated in JS) */
    --parallaxX: 0px;
    --parallaxY: 0px;
  }

  *{ box-sizing: border-box; }
  html, body { height:100%; margin:0; background:#0b0e12; color:var(--ui-text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

  /* Utility: any element with .parallax will shift together */
  .parallax{
    transform: translate3d(var(--parallaxX), var(--parallaxY), 0);
    will-change: transform;
    transition: transform 120ms ease-out;
  }

  /* Scene container with stacked <img> layers */
  #scene { position:fixed; inset:0; z-index:var(--z-scene); }
  #bgRoot { position:absolute; inset:0; overflow:hidden; }
  /* Underlay: blurred copy of base to hide seams during load/resize */
  #bgUnderlay { position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    filter: blur(26px) brightness(0.98); transform: scale(1.08); transform-origin:center; }
  #bgStack { position:absolute; inset:0; }
  .bg-img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    user-select:none; pointer-events:none; image-rendering:auto; }
  .bg-overlay { opacity:0; transition: opacity 120ms ease-in-out; }
  .bg-overlay.on { opacity:1; }

  /* FX canvas (rain/snow/leaves + god rays + caustics) */
  #fx { position:fixed; inset:0; z-index:var(--z-canvas); pointer-events:none; }

  /* Heat-haze (SVG displacement overlay; summer only) */
  #heatHazeSvg{ position:fixed; inset:0; z-index:var(--z-canvas); pointer-events:none; display:none; }
  #heatHazeImg{ width:100%; height:100%; }

  /* Overlays (lamp glows & window canvases) */
  #overlays { position:fixed; inset:0; z-index:var(--z-overlays); pointer-events:none; }
  .lamp-glow { position:fixed; width:300px; height:300px; left:50%; top:50%;
    transform:translate(calc(-50% + var(--parallaxX)), calc(-50% + var(--parallaxY)));
    border-radius:50%; mix-blend-mode:screen; pointer-events:none;
    animation: lampFlicker 1.8s infinite steps(6, end); }
  @keyframes lampFlicker { 0%{filter:brightness(.95);} 50%{filter:brightness(1.05);} 100%{filter:brightness(.95);} }
  .window-overlay { position:fixed; pointer-events:none; }

  /* Fire sprite (transform uses parallax vars so it stays aligned) */
  #fire-sprite { position:fixed; z-index:var(--z-sprite); width:0; height:0; display:none;
    background-repeat:no-repeat; image-rendering:auto; pointer-events:none; will-change:background-position;
    transform: translate(calc(-50% + var(--parallaxX)), calc(-50% + var(--parallaxY))) scale(1); }

  /* Hotspots */
  #hotspots { position:fixed; inset:0; z-index:var(--z-hotspots); pointer-events:none; }
  .hotspot { position:absolute; pointer-events:auto; cursor:pointer; background:transparent;
    border:2px dashed transparent; border-radius:8px; }
  .hotspot:focus-visible { outline:none; border-color:rgba(255,255,255,.7); }
  .hotspot.debug { border-color: rgba(255,255,255,.35); }

  /* Season picker */
  #season-picker { position:fixed; inset:0; z-index:var(--z-overlay);
    background:linear-gradient(180deg, rgba(6,8,10,.85), rgba(6,8,10,.85));
    display:grid; place-items:center; padding:clamp(20px,4vw,40px); }
  .picker-panel { width:min(920px,96vw); display:grid; gap:16px;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    backdrop-filter:blur(var(--ui-blur)); -webkit-backdrop-filter:blur(var(--ui-blur));
    background:var(--ui-bg); border:1px solid var(--ui-border); border-radius:16px; padding:20px; }
  .picker-header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;
    padding-bottom:8px; border-bottom:1px solid var(--ui-border); gap:8px; }
  .picker-header h1 { font-size:clamp(18px,3vw,22px); margin:0; font-weight:650; }
  .picker-grid { grid-column:1/-1; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .season-card { position:relative; border-radius:12px; overflow:hidden; border:1px solid var(--ui-border);
    aspect-ratio:4/3; display:flex; align-items:end; isolation:isolate; cursor:pointer; background:#151a1f; }
  .season-card img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    filter:brightness(.9); transform:scale(1.02); transition:transform .3s ease, filter .3s ease; z-index:0; }
  .season-card:hover img { transform:scale(1.06); filter:brightness(1); }
  .season-label { position:relative; z-index:1; width:100%; padding:10px 12px;
    background:linear-gradient(180deg, transparent, rgba(0,0,0,.6));
    font-weight:650; letter-spacing:.3px; text-shadow:0 2px 8px rgba(0,0,0,.6); }

  /* Top bar + controls */
  #topbar { position:fixed; left:14px; top:14px; z-index:var(--z-ui); display:flex; gap:8px;
    transition: opacity .25s ease, transform .25s ease; }
  .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--ui-border);
    padding:8px 12px; border-radius:24px; background:rgba(255,255,255,.06);
    color:var(--ui-text); text-decoration:none; cursor:pointer; font-weight:650; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }

  #controls { position:fixed; right:14px; bottom:14px; width:var(--panel-w); z-index:var(--z-ui); display:grid; gap:10px; user-select:none;
    transition: opacity .25s ease, transform .25s ease; }
  .panel { backdrop-filter:blur(var(--ui-blur)); -webkit-backdrop-filter:blur(var(--ui-blur));
    background:var(--ui-bg); border:1px solid var(--ui-border); border-radius:14px; padding:12px; }
  .panel h2 { margin:0 0 6px 0; font-size:14px; font-weight:700; color:var(--ui-muted); letter-spacing:.4px; text-transform:uppercase; }
  .row { display:flex; align-items:center; gap:10px; }
  .row.wrap { flex-wrap:wrap; }
  .row + .row { margin-top:8px; }
  .chip { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--ui-border);
    padding:8px 10px; border-radius:24px; background:rgba(255,255,255,.04); }
  .chip input[type="checkbox"] { accent-color:var(--ui-accent); transform:translateY(1px); }
  .chip .lbl { font-size:14px; font-weight:600; }
  .slider-wrap { flex:1; display:grid; gap:4px; }
  .slider-wrap label { font-size:12px; color:var(--ui-muted); }
  input[type="range"]{ width:100%; }
  .small { font-size:12px; color:var(--ui-muted); }

  /* Loader */
  #loader{ position:fixed; inset:0; z-index:var(--z-overlay); display:none; place-items:center;
    background:linear-gradient(180deg, rgba(6,8,10,.6), rgba(6,8,10,.6)); }
  .spinner{ width:46px; height:46px; border-radius:50%; border:5px solid rgba(255,255,255,.18);
    border-top-color:var(--ui-accent); animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* Auto-hide UI (applies to both topbar and control panel) */
  body.ui-hidden #topbar    { opacity:0; transform: translateY(-8px); pointer-events:none; }
  body.ui-hidden #controls  { opacity:0; transform: translateY( 8px); pointer-events:none; }

  @media (max-width: 720px){ #controls{ right:10px; left:10px; width:auto; } }
  @media (prefers-reduced-motion: reduce){
    .season-card img{ transition:none; }
    .parallax     { transition:none; }
  }
</style>
</head>
<body>

  <!-- Scene behind everything -->
  <div id="scene" class="parallax" role="img" aria-label="Ambience background">
    <div id="bgRoot">
      <img id="bgUnderlay" alt="">
      <div id="bgStack">
        <img id="baseImg" class="bg-img" alt="">
        <!-- overlay images (e.g., picnic) will be appended here as <img class="bg-img bg-overlay"> -->
      </div>
    </div>
  </div>

  <!-- Global FX canvas (rain/snow/leaves + god rays + caustics) -->
  <canvas id="fx" class="parallax"></canvas>

  <!-- Heat-haze SVG (summer only) -->
  <svg id="heatHazeSvg" class="parallax" viewBox="0 0 100 100" preserveAspectRatio="none">
    <defs>
      <!-- Displacement noise -->
      <filter id="heatHazeFilter">
        <feTurbulence type="fractalNoise" baseFrequency="0.012 0.02" numOctaves="2" seed="7" result="turb">
          <animate attributeName="baseFrequency" dur="6s" values="0.012 0.02;0.017 0.03;0.012 0.02" repeatCount="indefinite"/>
          <animate attributeName="seed" dur="8s" values="7;9;11;7" repeatCount="indefinite"/>
        </feTurbulence>
        <feDisplacementMap in="SourceGraphic" in2="turb" scale="6" xChannelSelector="R" yChannelSelector="G">
          <animate attributeName="scale" dur="7s" values="4;7;5;6;4" repeatCount="indefinite"/>
        </feDisplacementMap>
      </filter>
      <!-- Clip to a low horizontal band (approx heat shimmer near ground/water) -->
      <clipPath id="hazeClip">
        <rect x="0" y="58" width="100" height="42" />
      </clipPath>
    </defs>
    <!-- We draw the same scene image again, displaced & faint -->
    <image id="heatHazeImg" href="" x="0" y="0" width="100" height="100"
           preserveAspectRatio="xMidYMid slice" filter="url(#heatHazeFilter)"
           clip-path="url(#hazeClip)" opacity="0.12" style="mix-blend-mode:screen;"></image>
  </svg>

  <!-- Overlays (lamp glows, window canvases, etc.) -->
  <div id="overlays" class="parallax"></div>

  <!-- Fire sprite -->
  <div id="fire-sprite"></div>

  <!-- Hotspots -->
  <div id="hotspots" class="parallax"></div>

  <!-- Top bar -->
  <div id="topbar" class="panel">
    <button id="changeSeasonBtn" class="btn" title="Change season (S)">🌗 Change</button>
    <button id="toggleControlsBtn" class="btn" title="Show/Hide controls (C)">🎛 Controls</button>
    <button id="fullscreenBtn" class="btn" title="Fullscreen (F)">⛶ Fullscreen</button>
    <button id="muteBtn" class="btn" title="Mute/Unmute (M)">🔇 Mute</button>
    <button id="hotspotDebugBtn" class="btn" title="Show/Hide hotspot boxes (H)">🧪 Hotspots</button>
  </div>

  <!-- Controls -->
  <div id="controls" style="display:none;">

    <!-- Scene elements (per-season overlays like Picnic) -->
    <div id="elementsPanel" class="panel" style="display:none;">
      <h2>Scene elements</h2>
      <div id="elementsList" class="row wrap"></div>
      <div class="row small">Overlays align to the base image and fade in/out.</div>
    </div>

    <div class="panel">
      <h2>Weather</h2>
      <div class="row wrap">
        <span id="rainChip"     class="chip"><input id="rainOn" type="checkbox"><span class="lbl">Rain</span></span>
        <span id="snowChip"     class="chip"><input id="snowOn" type="checkbox"><span class="lbl">Snow</span></span>
        <span                   class="chip"><input id="windOn" type="checkbox" checked><span class="lbl">Wind</span></span>
        <span id="splashesChip" class="chip"><input id="splashesOn" type="checkbox" checked><span class="lbl">Rain splashes</span></span>
        <span id="leavesChip"   class="chip"><input id="leavesOn" type="checkbox"><span class="lbl">Autumn leaves</span></span>
        <span id="fireChip"     class="chip" style="display:none;"><input id="fireOn" type="checkbox"><span class="lbl">Fireplace</span></span>
      </div>
      <div class="row">
        <div id="rainWrap"   class="slider-wrap">
          <label for="rainIntensity">Rain intensity</label>
          <input id="rainIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div id="snowWrap"   class="slider-wrap">
          <label for="snowIntensity">Snow intensity</label>
          <input id="snowIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div id="leavesWrap" class="slider-wrap">
          <label for="leavesIntensity">Leaves intensity</label>
          <input id="leavesIntensity" type="range" min="0" max="100" step="1" value="40">
        </div>
      </div>
      <div class="row small">If rain splashes look off, tweak each scene’s <code>floorY</code> (% from top).</div>
    </div>

    <div class="panel">
      <h2>Audio Mixer</h2>
      <div class="row">
        <div class="slider-wrap"><label for="masterVol">Master</label><input id="masterVol" type="range" min="0" max="100" step="1" value="80"></div>
        <div class="slider-wrap"><label for="rainVol">Rain</label><input id="rainVol" type="range" min="0" max="100" step="1" value="70"></div>
        <div class="slider-wrap"><label for="fireVol">Fire</label><input id="fireVol" type="range" min="0" max="100" step="1" value="65"></div>
        <div class="slider-wrap"><label for="windVol">Wind</label><input id="windVol" type="range" min="0" max="100" step="1" value="45"></div>
        <div class="slider-wrap"><label for="birdsVol">Birds</label><input id="birdsVol" type="range" min="0" max="100" step="1" value="35"></div>
      </div>
    </div>
  </div>

  <!-- Season picker -->
  <div id="season-picker" aria-modal="true" role="dialog">
    <div class="picker-panel">
      <div class="picker-header">
        <h1>Choose a season to set the ambience</h1>
        <div class="small">You can change this anytime.</div>
      </div>
      <div class="picker-grid">
        <button class="season-card" data-season="winter" title="Winter">
          <img src="assets/winter.jpg" alt="Winter preview"><div class="season-label">❄️ Winter</div>
        </button>
        <button class="season-card" data-season="spring" title="Spring">
          <img src="assets/spring.jpg" alt="Spring preview"><div class="season-label">🌱 Spring</div>
        </button>
        <button class="season-card" data-season="summer" title="Summer">
          <img src="assets/summer.jpg" alt="Summer preview"><div class="season-label">🌞 Summer</div>
        </button>
        <button class="season-card" data-season="fall" title="Fall">
          <img src="assets/fall.jpg" alt="Fall preview"><div class="season-label">🍂 Fall</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader"><div class="spinner" aria-hidden="true"></div></div>

<script>
/* ===========================================================
   SCENES (seasonal rules + overlays like Picnic)
   =========================================================== */
const SCENES = {
  winter: {
    name: "Winter",
    image: "assets/winter.jpg",
    hasFireplace: true,
    fireHotspot: { x: 68, y: 70, w: 14, h: 22 },
    fireSprite: { url: "sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:18, scale:1.0, offsetX:0, offsetY:0 },
    floorY: 92,
    allow: { rain: false, snow: true,  leaves: false },
    props: [],
    overlays: [],
    defaults: {
      rainOn:false, snowOn:true,  windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.0, snowIntensity:0.55,
      volumes:{ master:.8, rain:.7, fire:.65, wind:.45, birds:.15 }
    }
  },
  spring: {
    name: "Spring",
    image: "assets/spring.jpg",
    hasFireplace:false,
    fireHotspot:null, fireSprite:null,
    floorY: 90,
    allow: { rain: true, snow: false, leaves: false },
    props: [],
    overlays: [],
    defaults: {
      rainOn:true, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.4, snowIntensity:0.0,
      volumes:{ master:.8, rain:.6, fire:0.0, wind:.35, birds:.55 }
    }
  },
  summer: {
    name: "Summer",
    image: "assets/summer.jpg",
    hasFireplace:true,
    fireHotspot:{ x:55, y:62, w:12, h:18 },
    fireSprite:{ url:"sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:20, scale:1.0, offsetX:0, offsetY:0 },
    floorY: 91,
    allow: { rain: false, snow: false, leaves: false },
    props: [],
    overlays: [
      /* ALWAYS OFF ON LOAD: enforce in buildOverlayControls */
      { key:"picnic", label:"Picnic", url:"assets/summer_picnic.png", default:false, alwaysOff:true }
    ],
    defaults: {
      rainOn:false, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.0, snowIntensity:0.0,
      volumes:{ master:.75, rain:.0, fire:.55, wind:.25, birds:.5 }
    }
  },
  fall: {
    name: "Fall",
    image: "assets/fall.jpg",
    hasFireplace:true,
    fireHotspot:{ x:64, y:68, w:16, h:20 },
    fireSprite:{ url:"sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:18, scale:1.05, offsetX:0, offsetY:0 },
    floorY: 92,
    allow: { rain: true, snow: false, leaves: true },
    props: [],
    overlays: [],
    defaults: {
      rainOn:true, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:true, leavesIntensity:0.5,
      rainIntensity:0.28, snowIntensity:0.0,
      volumes:{ master:.8, rain:.5, fire:.6, wind:.4, birds:.2 }
    }
  }
};

/* ===================== AUDIO ===================== */
/* You provide the audio files in /audio */
const AUDIO = {
  rain:  new Audio("audio/rain.mp3"),
  fire:  new Audio("audio/fire_crackle.mp3"),
  wind:  new Audio("audio/wind.mp3"),
  birds: new Audio("audio/birds.mp3")
};
for (const a of Object.values(AUDIO)) { a.loop = true; a.preload = "auto"; a.volume = 0; }
let masterVolume = 0.8, globalMuted = false, audioUnlocked = false;
function unlockAudio(){
  if (audioUnlocked) return; audioUnlocked = true;
  Object.values(AUDIO).forEach(a=>{
    try { a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});} catch {}
  });
}
function setTrackVolume(track, v){
  const a = AUDIO[track]; if(!a) return;
  const vol = Math.max(0, Math.min(1, v)) * masterVolume * (globalMuted ? 0 : 1);
  a.volume = vol; if (vol>0 && a.paused) { a.play().catch(()=>{}); }
}

/* ===================== CANVAS & SYSTEMS ===================== */
const fx = document.getElementById('fx');
const ctx = fx.getContext('2d');
let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resizeCanvas(){ DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  fx.width = Math.floor(window.innerWidth*DPR); fx.height = Math.floor(window.innerHeight*DPR);
}
window.addEventListener('resize', resizeCanvas, { passive:true }); resizeCanvas();
const clamp01 = v => Math.max(0, Math.min(1, v));

/* Visual wind for rain/snow/leaves */
const gust = { t: 0, val: 0 };
function updateGust(windOn) {
  gust.t += 0.003;
  const base = windOn ? 0.9 : 0.25;
  const wave = Math.sin(gust.t*3.2)*0.4 + Math.sin(gust.t*1.3+1.2)*0.25;
  gust.val = (base + wave) * DPR;
}

/* --------- GOD RAYS (screen-blended soft beams) ---------- */
const GodRays = (()=> {
  let t=0;
  function draw(intensity=0.8){
    const W=fx.width, H=fx.height; if(!W||!H) return;
    t += 0.003;
    const sx = W*0.16, sy = H*0.12; // source
    const beams = 7, span = Math.PI/3.2;
    ctx.save();
    ctx.globalCompositeOperation='screen';
    ctx.filter='blur(8px)';
    ctx.translate(sx, sy);
    for(let i=0;i<beams;i++){
      const a = -span/2 + (i/(beams-1))*span + Math.sin(t*0.7 + i)*0.02;
      ctx.save(); ctx.rotate(a);
      const w = (H*0.28) * (0.65 + 0.45*Math.sin(t*0.9 + i));
      const g = ctx.createLinearGradient(0,0,W*0.9,0);
      const alpha = 0.06 * intensity;
      g.addColorStop(0, `rgba(255,245,210,${alpha})`);
      g.addColorStop(0.25, `rgba(255,245,210,${alpha*0.6})`);
      g.addColorStop(1, `rgba(255,245,210,0)`);
      ctx.fillStyle = g;
      ctx.fillRect(0,-w/2, W, w);
      ctx.restore();
    }
    ctx.filter='none';
    ctx.restore();
  }
  return { draw };
})();

/* --------- CAUSTICS (summer, additive bottom-band) --------- */
const Caustics = (()=>{
  const off = document.createElement('canvas'); const g = off.getContext('2d');
  let t=0;
  function ensure(size=180){ if(off.width===size) return; off.width=off.height=size; }
  function draw(enabled, alpha=0.14){
    if(!enabled) return;
    const W=fx.width, H=fx.height; if(!W||!H) return;
    ensure(160); t+=0.03;
    // generate small tile with interference pattern
    const imgData = g.createImageData(off.width, off.height);
    const d = imgData.data, w=off.width, h=off.height;
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const nx=x/w, ny=y/h;
        const v =
          (Math.sin( (nx*15 + t) ) + Math.sin( (ny*19 + t*1.2) ) +
           Math.sin( (nx*12 + ny*8 + t*0.8) ))/3;
        const c = Math.max(0, v*255);
        const idx=(y*w+x)*4; d[idx]=d[idx+1]=d[idx+2]=255; d[idx+3]=c;
      }
    }
    g.putImageData(imgData,0,0);
    const pattern = ctx.createPattern(off,'repeat');
    ctx.save();
    ctx.globalCompositeOperation='screen';
    ctx.globalAlpha = alpha;
    ctx.fillStyle = pattern;
    // bottom 35% with soft vertical fade
    const grad = ctx.createLinearGradient(0, H*0.65, 0, H);
    grad.addColorStop(0,'rgba(255,255,255,0)');
    grad.addColorStop(1,'rgba(255,255,255,1)');
    ctx.fillStyle = pattern;
    ctx.beginPath(); ctx.rect(0, H*0.65, W, H*0.35); ctx.fill();
    // apply fade mask by overlaying gradient in destination-in mode
    ctx.globalCompositeOperation='destination-in';
    ctx.fillStyle=grad; ctx.fillRect(0, H*0.65, W, H*0.35);
    ctx.restore();
  }
  return { draw };
})();

/* --------- SPLASHES (rain impact) --------- */
class SplashSystem {
  constructor(){ this.jets=[]; this.ripples=[]; this.enabled=true; this.floorYpx = fx.height*0.92; }
  setEnabled(on){ this.enabled = on; } setFloorY(yPx){ this.floorYpx = yPx; }
  spawn(x, strength=1){ if (!this.enabled) return;
    const n=3+Math.floor(Math.random()*3);
    for (let i=0;i<n;i++){ const a=(Math.random()*Math.PI/3)+Math.PI/3;
      const speed=(3+Math.random()*3)*strength*DPR;
      const vx=Math.cos(a)*speed*(Math.random()<0.5?-1:1)*0.55;
      const vy=-Math.abs(Math.sin(a)*speed*1.15);
      this.jets.push({ x, y:this.floorYpx-1, vx, vy, life:1, decay:0.06+Math.random()*0.04 });
    }
    const rMax=(6+Math.random()*10)*DPR*(0.6+strength*0.8);
    this.ripples.push({ x, y:this.floorYpx, r:2, rMax, alpha:0.35, fade:0.015+Math.random()*0.01, width:1.2*DPR });
  }
  update(){ for (let j of this.jets){ j.vy+=0.25*DPR; j.x+=j.vx+gust.val*0.15; j.y+=j.vy; j.life-=j.decay; }
    this.jets=this.jets.filter(j=>j.life>0 && j.y<this.floorYpx+4*DPR);
    for (let r of this.ripples){ r.r+=0.9*DPR; r.alpha-=r.fade; }
    this.ripples=this.ripples.filter(r=>r.alpha>0 && r.r<r.rMax);
  }
  draw(){ if (this.jets.length){ ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.globalAlpha=0.7; ctx.fillStyle='rgba(190,210,255,.65)';
      for (let j of this.jets){ ctx.beginPath(); ctx.arc(j.x,j.y,1.2*DPR,0,Math.PI*2); ctx.fill(); } ctx.restore(); }
    if (this.ripples.length){ ctx.save(); ctx.strokeStyle='rgba(200,220,255,0.5)';
      for (let r of this.ripples){ ctx.globalAlpha=r.alpha; ctx.lineWidth=r.width; ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,Math.PI*2); ctx.stroke(); } ctx.restore(); } }
}

/* --------- RAIN --------- */
class RainSystem {
  constructor(){ this.drops=[]; this.intensity=0; this.floorYpx=fx.height*0.92; this.enabled=false; this.splashes=new SplashSystem(); }
  setEnabled(on){ this.enabled = on; } setSplashes(on){ this.splashes.setEnabled(on); }
  setFloorY(yPx){ this.floorYpx=yPx; this.splashes.setFloorY(yPx); }
  setIntensity(f){ this.intensity = clamp01(f); }
  spawnOne(layer=1){ const W=fx.width, H=fx.height;
    const x=Math.random()*(W+100*DPR)-50*DPR; const y=-Math.random()*H*0.15;
    const vy=[10,14,19][layer]*DPR + Math.random()*[5,6,7][layer]*DPR;
    const slope=0.25+Math.random()*0.25; const vx=slope*vy;
    const w=[0.7,1.0,1.4][layer]*DPR; const alpha=[0.35,0.55,0.8][layer];
    this.drops.push({x,y,vx,vy,w,alpha,layer}); }
  ensureCount(){ const target=Math.floor(this.intensity*900);
    while(this.drops.length<target){ const r=Math.random(); const layer=r<0.2?2:(r<0.75?1:0); this.spawnOne(layer); }
    if(this.drops.length>target) this.drops.length=target; }
  update(){ if(!this.enabled || this.intensity<=0) return; this.ensureCount();
    const W=fx.width, H=fx.height;
    for(let d of this.drops){ d.x+=d.vx+gust.val*(0.25+d.layer*0.25); d.y+=d.vy;
      if(d.y>=this.floorYpx){ this.splashes.spawn(d.x,0.7+d.layer*0.3); d.y=-Math.random()*H*0.2; d.x=Math.random()*(W+100*DPR)-50*DPR; }
      if(d.x<-60*DPR) d.x=W+60*DPR; if(d.x>W+60*DPR) d.x=-60*DPR; }
    this.splashes.update(); }
  draw(){ if(!this.enabled || this.intensity<=0) return;
    ctx.save(); ctx.lineCap='round';
    for(let pass=0; pass<3; pass++){ for(let d of this.drops){ if(d.layer!==pass) continue;
      ctx.globalAlpha=d.alpha; ctx.strokeStyle='#bcd7ff'; ctx.lineWidth=d.w; ctx.beginPath();
      ctx.moveTo(d.x,d.y); ctx.lineTo(d.x-(d.vx+gust.val*0.2)*0.5, d.y-d.vy*0.5); ctx.stroke(); } }
    ctx.restore(); this.splashes.draw(); }
}

/* --------- SNOW --------- */
function makeFlakeSprite(r){ const c=document.createElement('canvas'); c.width=c.height=Math.ceil(r*2+2);
  const g=c.getContext('2d'); const cx=c.width/2, cy=c.height/2;
  const grd=g.createRadialGradient(cx,cy,0,cx,cy,r);
  grd.addColorStop(0,'rgba(255,255,255,.95)'); grd.addColorStop(0.6,'rgba(255,255,255,.55)'); grd.addColorStop(1,'rgba(255,255,255,0)');
  g.fillStyle=grd; g.beginPath(); g.arc(cx,cy,r,0,Math.PI*2); g.fill(); return c; }
const SNOW_SPRITES=[makeFlakeSprite(1.2*DPR),makeFlakeSprite(1.8*DPR),makeFlakeSprite(2.4*DPR)];
class SnowSystem{
  constructor(){ this.flakes=[]; this.intensity=0; this.enabled=false; }
  setEnabled(on){ this.enabled=on; } setIntensity(f){ this.intensity=clamp01(f); }
  ensureCount(){ const target=Math.floor(this.intensity*420); while(this.flakes.length<target) this.spawn(); if(this.flakes.length>target) this.flakes.length=target; }
  spawn(){ const W=fx.width,H=fx.height; const z=Math.random(); const idx=(z<0.33?0:(z<0.66?1:2));
    const vx=(Math.random()*0.3-0.15)*DPR; const vy=(0.4+Math.random()*0.6)*(0.6+z*0.8)*DPR;
    this.flakes.push({ x:Math.random()*W, y:-Math.random()*H*0.2, vx, vy, swing:(0.4+Math.random()*1.6)*DPR, t:Math.random()*Math.PI*2, tw:0.008+Math.random()*0.02,
      z, s:SNOW_SPRITES[idx], alpha:0.6+(1-z)*0.35 }); }
  update(){ if(!this.enabled||this.intensity<=0) return; this.ensureCount(); const W=fx.width,H=fx.height;
    for(let f of this.flakes){ f.t+=f.tw; const sway=Math.sin(f.t)*f.swing; f.x+=f.vx+sway*0.02+gust.val*0.12*(0.5+f.z); f.y+=f.vy;
      if(f.y>H){ f.y=-10*DPR; f.x=Math.random()*W; } if(f.x<-50*DPR) f.x=W+50*DPR; if(f.x>W+50*DPR) f.x=-50*DPR; } }
  draw(){ if(!this.enabled||this.intensity<=0) return; ctx.save(); for(let f of this.flakes){ ctx.globalAlpha=f.alpha; ctx.drawImage(f.s,f.x-f.s.width/2,f.y-f.s.height/2); } ctx.restore(); }
}

/* --------- LEAVES (autumn) --------- */
class LeafSystem{
  constructor(){ this.enabled=false; this.intensity=0; this.leaves=[]; this.sprites=[]; this.ready=false; this.fallbackColors=['#c55c18','#d79a2e','#9a5a1a','#bf6f24']; }
  async load(urls){ const loads=urls.map(u=>new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>res(null); img.src=u; }));
    const imgs=await Promise.all(loads); this.sprites=imgs.filter(Boolean); this.ready=this.sprites.length>0; }
  setEnabled(on){ this.enabled=on; } setIntensity(f){ this.intensity=clamp01(f); }
  ensureCount(){ const target=Math.floor(this.intensity*180); while(this.leaves.length<target) this.spawn(); if(this.leaves.length>target) this.leaves.length=target; }
  spawn(){ const W=fx.width,H=fx.height; const scale=0.6+Math.random()*0.9; const vx=(Math.random()*0.6+0.3)*DPR; const vy=(0.8+Math.random()*1.4)*DPR;
    const rot=Math.random()*Math.PI*2, rotSpd=(Math.random()*0.02 - 0.01);
    const sprite=this.ready?this.sprites[Math.floor(Math.random()*this.sprites.length)]:null;
    const color=this.fallbackColors[Math.floor(Math.random()*this.fallbackColors.length)];
    this.leaves.push({ x:-20*DPR+Math.random()*W, y:-Math.random()*H*0.3, vx, vy, rot, rotSpd, scale, sprite, color }); }
  update(){ if(!this.enabled||this.intensity<=0) return; this.ensureCount(); const W=fx.width,H=fx.height;
    for(let L of this.leaves){ L.x+=L.vx+gust.val*0.35; L.y+=L.vy*(0.6+0.4*Math.sin(L.rot*2)); L.rot+=L.rotSpd+0.006*Math.sin(L.x*0.01);
      if(L.y>H+30*DPR){ L.y=-20*DPR; L.x=Math.random()*W; } if(L.x>W+30*DPR) L.x=-30*DPR; } }
  draw(){ if(!this.enabled||this.intensity<=0) return; ctx.save();
    for(let L of this.leaves){ ctx.translate(L.x,L.y); ctx.rotate(L.rot); ctx.scale(L.scale,L.scale);
      if(L.sprite){ const w=L.sprite.width,h=L.sprite.height; ctx.globalAlpha=0.9; ctx.drawImage(L.sprite, -w/2, -h/2); }
      else { ctx.fillStyle=L.color; ctx.globalAlpha=0.85; ctx.beginPath(); ctx.moveTo(0,-8*DPR); ctx.quadraticCurveTo(10*DPR,0,0,8*DPR);
        ctx.quadraticCurveTo(-10*DPR,0,0,-8*DPR); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=0.8*DPR; ctx.stroke(); }
      ctx.setTransform(1,0,0,1,0,0); }
    ctx.restore(); }
}
const leafFX = new LeafSystem();
leafFX.load(["sprites/leaves/leaf1.png","sprites/leaves/leaf2.png","sprites/leaves/leaf3.png"]).catch(()=>{});

/* --------- RENDER LOOP --------- */
const rainFX = new RainSystem(); const snowFX = new SnowSystem();
let running=true;
let enableHaze=false, enableCaustics=false, raysIntensity=0.8;
function loop(){ if(!running) return;
  ctx.clearRect(0,0,fx.width,fx.height);

  // Background/ambient passes first
  if (raysIntensity>0) GodRays.draw(raysIntensity);
  Caustics.draw(enableCaustics, 0.14);

  updateGust(document.getElementById('windOn').checked);
  rainFX.update(); snowFX.update(); leafFX.update();
  rainFX.draw();   snowFX.draw();   leafFX.draw();

  windowTrails.forEach(w => w.updateDraw());
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===================== FIRE SPRITE ===================== */
class FireSprite{ constructor(el){ this.el=el; this.cfg=null; this.frame=0; this.timer=null; this.total=0; }
  load(cfg){ this.cfg=cfg; this.frame=0; this.total=cfg.cols*cfg.rows; this.el.style.backgroundImage=`url('${cfg.url}')`;
    this.el.style.width=cfg.frameW+'px'; this.el.style.height=cfg.frameH+'px'; this.el.style.backgroundSize=`${cfg.cols*100}% ${cfg.rows*100}%`; }
  place(px,py,scale=1){ this.el.style.left=px+'px'; this.el.style.top=py+'px';
    this.el.style.transform=`translate(calc(-50% + var(--parallaxX)), calc(-50% + var(--parallaxY))) scale(${scale})`; }
  start(){ if(!this.cfg) return; this.el.style.display='block';
    const step=()=>{ this.frame=(this.frame+1)%this.total; const c=this.frame%this.cfg.cols, r=Math.floor(this.frame/this.cfg.cols);
      const posX=(c/(this.cfg.cols-1))*100, posY=(r/(this.cfg.rows-1))*100; this.el.style.backgroundPosition=`${posX}% ${posY}%`;
      this.timer=setTimeout(step, 1000/this.cfg.fps); }; step(); }
  stop(){ this.el.style.display='none'; if(this.timer){ clearTimeout(this.timer); this.timer=null; } } }
const fireSprite = new FireSprite(document.getElementById('fire-sprite'));

/* ===================== PROPS (LAMP / WINDOW) ===================== */
const overlaysEl = document.getElementById('overlays'); const windowTrails = [];
function pctBoxToPx(box){ const vw=window.innerWidth, vh=window.innerHeight; return { left:vw*(box.x/100), top:vh*(box.y/100), width:vw*(box.w/100), height:vh*(box.h/100) }; }
function makeLampGlow(box, color="rgba(255,210,140,0.9)", radius=320){
  const px = pctBoxToPx(box); const d = document.createElement('div'); d.className = 'lamp-glow';
  const cx = px.left + px.width/2, cy = px.top + px.height/2; d.style.left = cx + 'px'; d.style.top = cy + 'px';
  d.style.width = radius + 'px'; d.style.height = radius + 'px';
  d.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,200,120,0.6) 35%, rgba(255,160,80,0.18) 65%, rgba(255,120,60,0.05) 100%)`;
  overlaysEl.appendChild(d);
  return { el: d, resize(){ const px=pctBoxToPx(box); const cx=px.left+px.width/2, cy=px.top+px.height/2; d.style.left=cx+'px'; d.style.top=cy+'px'; } };
}
class WindowTrail { constructor(boxPct){ this.boxPct=boxPct; this.canvas=null; this.ctx=null; this.streams=[]; this.active=false; }
  attach(){ const px=pctBoxToPx(this.boxPct); const c=document.createElement('canvas'); c.className='window-overlay parallax';
    c.style.left=px.left+'px'; c.style.top=px.top+'px'; c.width=Math.max(1, Math.floor(px.width*DPR)); c.height=Math.max(1, Math.floor(px.height*DPR));
    c.style.width=px.width+'px'; c.style.height=px.height+'px'; overlaysEl.appendChild(c); this.canvas=c; this.ctx=c.getContext('2d'); this.active=true; this.buildStreams(); }
  detach(){ if(this.canvas){ this.canvas.remove(); this.canvas=null; this.ctx=null; } this.active=false; }
  resize(){ if(!this.canvas) return; const px=pctBoxToPx(this.boxPct);
    this.canvas.style.left=px.left+'px'; this.canvas.style.top=px.top+'px';
    this.canvas.width=Math.max(1, Math.floor(px.width*DPR)); this.canvas.height=Math.max(1, Math.floor(px.height*DPR));
    this.canvas.style.width=px.width+'px'; this.canvas.style.height=px.height+'px'; this.buildStreams(); }
  buildStreams(){ if(!this.ctx) return; this.streams=[]; const W=this.canvas.width,H=this.canvas.height;
    const count=Math.max(4, Math.floor(W/70)); for(let i=0;i<count;i++){ this.streams.push({ x:Math.random()*W, y:Math.random()*H*0.2, speed:(0.6+Math.random()*1.2)*DPR,
      len:(H*0.25)+Math.random()*H*0.35, w:(0.8+Math.random()*1.4)*DPR, alpha:0.25+Math.random()*0.25 }); } }
  updateDraw(){ if(!this.active||!this.ctx) return; const W=this.canvas.width,H=this.canvas.height,g=this.ctx;
    g.globalCompositeOperation='destination-out'; g.fillStyle='rgba(0,0,0,0.08)'; g.fillRect(0,0,W,H);
    g.globalCompositeOperation='source-over';
    for(let s of this.streams){ s.y+=s.speed+Math.max(0, gust.val*0.15); if(s.y-s.len>H){ s.y=-Math.random()*H*0.1; s.x=Math.random()*W; }
      const grad=g.createLinearGradient(s.x, s.y-s.len, s.x, s.y); grad.addColorStop(0,'rgba(200,220,255,0)'); grad.addColorStop(1,`rgba(200,220,255,${s.alpha})`);
      g.strokeStyle=grad; g.lineWidth=s.w; g.beginPath(); g.moveTo(s.x, s.y-s.len); g.lineTo(s.x, s.y); g.stroke(); } } }

/* ===================== UI & STATE ===================== */
const $ = s => document.querySelector(s);
const sceneEl = $('#scene'), baseImg = $('#baseImg'), bgUnderlay = $('#bgUnderlay');
const heatHazeSvg = $('#heatHazeSvg'), heatHazeImg = $('#heatHazeImg');
const hotspotsEl = $('#hotspots'), seasonPicker = $('#season-picker'), loader = $('#loader'), controls = $('#controls');
const changeSeasonBtn = $('#changeSeasonBtn'), toggleControlsBtn = $('#toggleControlsBtn'), muteBtn = $('#muteBtn'), hotspotDebugBtn = $('#hotspotDebugBtn');
const fullscreenBtn = $('#fullscreenBtn');
const elementsPanel = $('#elementsPanel'), elementsList = $('#elementsList');

const rainOn = $('#rainOn'), snowOn=$('#snowOn'), windOn=$('#windOn'), splashesOn=$('#splashesOn'), fireOn=$('#fireOn'), leavesOn=$('#leavesOn');
const rainIntensity = $('#rainIntensity'), snowIntensity=$('#snowIntensity'), leavesIntensity=$('#leavesIntensity');
const masterVol = $('#masterVol'), rainVol=$('#rainVol'), fireVol=$('#fireVol'), windVol=$('#windVol'), birdsVol=$('#birdsVol');
const fireChip = $('#fireChip');

const rainChipEl = $('#rainChip'), snowChipEl = $('#snowChip'), splashesChipEl = $('#splashesChip'), leavesChipEl = $('#leavesChip');
const rainWrapEl = $('#rainWrap'), snowWrapEl = $('#snowWrap'), leavesWrapEl = $('#leavesWrap');

let currentSeasonKey=null, currentCfg=null, fireplaceBounds=null, hotspotDebug=false;
let overlayState = {};          // {key:boolean}
let overlayImgs  = {};          // {key: HTMLImageElement}
const STORE_KEY='ambience.settings.v3';

/* Save/load (picnic always starts off regardless of saved) */
function saveSettings(){
  try{
    const overlays = {};
    elementsList.querySelectorAll('input[data-overlay]').forEach(inp => overlays[inp.dataset.overlay] = !!inp.checked);
    localStorage.setItem(STORE_KEY, JSON.stringify({
      season: currentSeasonKey,
      rainOn: rainOn.checked, snowOn: snowOn.checked, windOn: windOn.checked, splashesOn: splashesOn.checked, fireOn: fireOn?.checked, leavesOn: leavesOn.checked,
      rainIntensity:+rainIntensity.value/100, snowIntensity:+snowIntensity.value/100, leavesIntensity:+leavesIntensity.value/100,
      volumes:{ master:+masterVol.value/100, rain:+rainVol.value/100, fire:+fireVol.value/100, wind:+windVol.value/100, birds:+birdsVol.value/100 },
      overlays, muted:globalMuted
    }));
  } catch{}
}
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)); }catch{return null;} }
function showLoader(flag){ loader.style.display = flag ? 'grid' : 'none'; }
function show(el, on) { if (!el) return; el.style.display = on ? '' : 'none'; }

/* ------- Overlays (Picnic) as real <img> with fade ------- */
function clearOverlayImages(){ Object.values(overlayImgs).forEach(img => img.remove()); overlayImgs = {}; }
function ensureOverlayImage(def){
  if (overlayImgs[def.key]) return overlayImgs[def.key];
  const img = new Image(); img.className = 'bg-img bg-overlay'; img.alt = def.label || def.key; img.src = def.url;
  document.getElementById('bgStack').appendChild(img); overlayImgs[def.key] = img; return img;
}
function syncOverlayImages(){
  const defs = currentCfg.overlays || [];
  defs.forEach(def=>{
    const want = !!overlayState[def.key];
    const img = ensureOverlayImage(def);
    if (want) img.classList.add('on'); else img.classList.remove('on');
  });
  elementsPanel.style.display = defs.length ? '' : 'none';
}
function buildOverlayControls(){
  elementsList.innerHTML = '';
  clearOverlayImages();
  const defs = currentCfg.overlays || [];
  if (!defs.length){ overlayState = {}; elementsPanel.style.display='none'; return; }

  // Start overlays from defaults, then override from saved EXCEPT items marked alwaysOff
  overlayState = Object.fromEntries(defs.map(d => [d.key, !!d.default]));
  const saved = loadSettings();
  if (saved && saved.season===currentSeasonKey && saved.overlays){
    for (const k in saved.overlays){
      const def = defs.find(d=>d.key===k);
      if (!def) continue;
      if (def.alwaysOff) { overlayState[k] = false; } else { overlayState[k] = !!saved.overlays[k]; }
    }
  }
  // hard-enforce alwaysOff on load
  defs.forEach(d => { if (d.alwaysOff) overlayState[d.key] = false; });

  defs.forEach(d=>{
    const span = document.createElement('span'); span.className='chip'; const id=`overlay-${d.key}`;
    span.innerHTML = `<input type="checkbox" id="${id}" data-overlay="${d.key}" ${overlayState[d.key]?'checked':''}><span class="lbl">${d.label}</span>`;
    elementsList.appendChild(span);
  });
  elementsPanel.style.display='';
  elementsList.querySelectorAll('input[data-overlay]').forEach(inp=>{
    inp.addEventListener('change', ()=>{ overlayState[inp.dataset.overlay] = inp.checked; syncOverlayImages(); saveSettings(); });
  });
  syncOverlayImages();
}

/* ------- Weather controls visibility ------- */
function updateVisibilityForSeason() {
  const allow = currentCfg?.allow || { rain:true, snow:true, leaves:(currentSeasonKey==='fall') };
  show(rainChipEl,     allow.rain); show(rainWrapEl, allow.rain); show(splashesChipEl, allow.rain);
  show(snowChipEl, allow.snow); show(snowWrapEl, allow.snow);
  const leavesAllowed = !!(allow.leaves && currentSeasonKey==='fall'); show(leavesChipEl, leavesAllowed); show(leavesWrapEl, leavesAllowed);
}
function enforceSeasonConstraints() {
  const allow = currentCfg?.allow || {};
  if (!allow.rain) { rainOn.checked=false; rainFX.setEnabled(false); rainFX.setIntensity(0); setTrackVolume('rain',0); }
  if (!allow.snow) { snowOn.checked=false; snowFX.setEnabled(false); snowFX.setIntensity(0); }
  if (!(allow.leaves && currentSeasonKey==='fall')) { leavesOn.checked=false; leafFX.setEnabled(false); leafFX.setIntensity(0); }
}

/* ------- Season load ------- */
async function loadSeason(key){
  currentSeasonKey = key; currentCfg = SCENES[key]; showLoader(true);

  // Base image on both underlay and main
  await new Promise(res=>{ const i=new Image(); i.onload=res; i.onerror=res; i.src=currentCfg.image; });
  baseImg.src = currentCfg.image; bgUnderlay.src = currentCfg.image;
  // Heat haze image (summer only)
  heatHazeImg.setAttribute('href', currentCfg.image);
  heatHazeSvg.style.display = (key==='summer') ? 'block' : 'none';

  // Seasonal FX toggles
  enableHaze = (key==='summer');
  enableCaustics = (key==='summer');
  raysIntensity = (key==='summer') ? 0.5 : 0.85;

  // reset overlays (canvases)
  overlaysEl.innerHTML=''; windowTrails.splice(0, windowTrails.length);

  // build overlay UI + layers
  buildOverlayControls();

  // hotspots reset
  hotspotsEl.innerHTML=''; fireplaceBounds=null;
  if(currentCfg.hasFireplace && currentCfg.fireHotspot){
    const hot=document.createElement('button'); hot.className='hotspot'; hot.title='Toggle fireplace'; hot.setAttribute('aria-label','Toggle fireplace');
    hotspotsEl.appendChild(hot); positionHotspot(hot, currentCfg.fireHotspot); hot.addEventListener('click', ()=> toggleFire());
    if (hotspotDebug) hot.classList.add('debug');
    fireplaceBounds = pctBoxToPx(currentCfg.fireHotspot);
    if (currentCfg.fireSprite) fireSprite.load(currentCfg.fireSprite); placeFireSprite();
    fireChip.style.display=''; if (fireOn) fireOn.checked = currentCfg.defaults.fireOn;
  } else { fireChip.style.display='none'; if (fireOn){ fireOn.checked=false; } fireSprite.stop(); }

  // Defaults + saved
  const saved = loadSettings(); const def = currentCfg.defaults; const v = (saved && saved.season===key) ? saved : null;
  rainOn.checked  = v ? v.rainOn  : def.rainOn;
  snowOn.checked  = v ? v.snowOn  : def.snowOn;
  windOn.checked  = v ? v.windOn  : def.windOn;
  splashesOn.checked = v ? v.splashesOn : def.splashesOn;
  leavesOn.checked = v ? v.leavesOn : def.leavesOn;
  if (fireOn) fireOn.checked = v ? !!v.fireOn : def.fireOn;

  rainIntensity.value = Math.round(100*(v ? v.rainIntensity : def.rainIntensity));
  snowIntensity.value = Math.round(100*(v ? v.snowIntensity : def.snowIntensity));
  leavesIntensity.value= Math.round(100*(v ? v.leavesIntensity : def.leavesIntensity));

  masterVol.value = Math.round(100*(v ? v.volumes.master : def.volumes.master));
  rainVol.value   = Math.round(100*(v ? v.volumes.rain   : def.volumes.rain));
  fireVol.value   = Math.round(100*(v ? v.volumes.fire   : def.volumes.fire));
  windVol.value   = Math.round(100*(v ? v.volumes.wind   : def.volumes.wind));
  birdsVol.value  = Math.round(100*(v ? v.volumes.birds  : def.volumes.birds));

  globalMuted = v ? !!v.muted : false; updateMuteButton();

  // Weather floor & systems
  const floorPx = fx.height * (currentCfg.floorY/100);
  rainFX.setFloorY(floorPx); rainFX.setSplashes(splashesOn.checked);
  snowFX.setEnabled(snowOn.checked); rainFX.setEnabled(rainOn.checked);

  updateVisibilityForSeason(); enforceSeasonConstraints();

  // Leaves only in Fall
  leafFX.setEnabled(leavesOn.checked && currentSeasonKey==='fall');

  applyWeather(); applyVolumes();

  if (fireOn?.checked && currentCfg.hasFireplace) lightFire(); else extinguishFire();

  showLoader(false);
  controls.style.display='grid';
  seasonPicker.style.display='none';
}

/* Helpers */
function positionHotspot(el, pct){ const r=pctBoxToPx(pct);
  el.style.left=r.left+'px'; el.style.top=r.top+'px'; el.style.width=r.width+'px'; el.style.height=r.height+'px'; }
function placeFireSprite(){ if(!fireplaceBounds || !currentCfg?.fireSprite) return;
  const {left,top,width,height}=fireplaceBounds;
  const cx=left+width/2+(currentCfg.fireSprite.offsetX||0), cy=top+height/2+(currentCfg.fireSprite.offsetY||0);
  fireSprite.place(cx,cy,currentCfg.fireSprite.scale||1);
}

/* ------- Weather/Audio ------- */
function applyWeather(){
  const allow = currentCfg?.allow || { rain:true, snow:true, leaves:(currentSeasonKey==='fall') };
  const rainAllowed=!!allow.rain, snowAllowed=!!allow.snow, leavesAllowed=!!(allow.leaves && currentSeasonKey==='fall');

  const rainEnabled = rainAllowed && rainOn.checked; rainFX.setEnabled(rainEnabled);
  rainFX.setIntensity(rainEnabled ? (+rainIntensity.value/100) : 0);
  rainFX.setSplashes(rainEnabled && splashesOn.checked);

  const snowEnabled = snowAllowed && snowOn.checked; snowFX.setEnabled(snowEnabled);
  snowFX.setIntensity(snowEnabled ? (+snowIntensity.value/100) : 0);

  const leavesEnabled=leavesAllowed && leavesOn.checked; leafFX.setEnabled(leavesEnabled);
  leafFX.setIntensity(leavesEnabled ? (+leavesIntensity.value/100) : 0);

  setTrackVolume('wind', windOn.checked ? (+windVol.value/100) : 0);
  setTrackVolume('rain', (rainEnabled ? (+rainVol.value/100) : 0) * Math.max(.25, +rainIntensity.value/100));
  saveSettings();
}
function applyVolumes(){
  masterVolume = +masterVol.value/100;
  const allow = currentCfg?.allow || {};
  const rainEnabled = !!allow.rain && rainOn.checked;
  setTrackVolume('rain', (rainEnabled ? +rainVol.value/100 : 0) * Math.max(.25, +rainIntensity.value/100));
  setTrackVolume('fire',  fireOn?.checked ? +fireVol.value/100 : 0);
  setTrackVolume('wind',  windOn.checked ? +windVol.value/100 : 0);
  setTrackVolume('birds', +birdsVol.value/100); // constant
  saveSettings();
}

/* ------- Fireplace ------- */
function lightFire(){ if(!currentCfg || !currentCfg.hasFireplace) return;
  if (currentCfg.fireSprite) fireSprite.start(); setTrackVolume('fire', +fireVol.value/100); fireOn && (fireOn.checked=true); saveSettings(); }
function extinguishFire(){ fireSprite.stop(); setTrackVolume('fire',0); fireOn && (fireOn.checked=false); saveSettings(); }
function toggleFire(){ fireOn.checked ? extinguishFire() : lightFire(); }

/* ------- Mute & helpers ------- */
function updateMuteButton(){ muteBtn.textContent = globalMuted ? '🔊 Unmute' : '🔇 Mute'; applyVolumes(); }
function toggleMute(){ globalMuted = !globalMuted; updateMuteButton(); saveSettings(); }

/* ------- Fullscreen ------- */
// reuse the already-declared `fullscreenBtn`
if (fullscreenBtn) {
  fullscreenBtn.addEventListener('click', ()=>{
    if (document.fullscreenElement) document.exitFullscreen();
    else document.documentElement.requestFullscreen().catch(()=>{});
  });
  window.addEventListener('keydown', e=>{
    if (e.key==='f' || e.key==='F') fullscreenBtn.click();
  });
}

/* ------- Auto-hide UI after idle ------- */
let uiIdleTimer=null, uiHover=false;
function scheduleUIHide(){
  clearTimeout(uiIdleTimer);
  uiIdleTimer = setTimeout(()=>{ if(!uiHover) document.body.classList.add('ui-hidden'); }, 3500);
}
function showUI(){ document.body.classList.remove('ui-hidden'); scheduleUIHide(); }
['mousemove','touchstart','keydown'].forEach(ev=>{
  window.addEventListener(ev, showUI, {passive:true});
});
['mouseenter','mouseleave'].forEach(ev=>{
  document.getElementById('topbar').addEventListener(ev, e=>{ uiHover = (ev==='mouseenter'); if(uiHover) showUI(); });
  document.getElementById('controls').addEventListener(ev, e=>{ uiHover = (ev==='mouseenter'); if(uiHover) showUI(); });
});
scheduleUIHide();

/* ------- Parallax (mouse + tilt) ------- */
(function setupParallax(){
  let targetX=0, targetY=0, curX=0, curY=0;
  const MAX = Math.min(12, Math.max(6, Math.floor(window.innerWidth/140))); // px
  function apply(){ curX += (targetX - curX)*0.12; curY += (targetY - curY)*0.12;
    document.documentElement.style.setProperty('--parallaxX', `${curX.toFixed(2)}px`);
    document.documentElement.style.setProperty('--parallaxY', `${curY.toFixed(2)}px`);
    requestAnimationFrame(apply);
  }
  apply();
  window.addEventListener('mousemove', (e)=>{
    const nx = (e.clientX / window.innerWidth  - 0.5) * 2;
    const ny = (e.clientY / window.innerHeight - 0.5) * 2;
    targetX = -nx*MAX; targetY = -ny*MAX;
  }, {passive:true});
  // Mobile tilt (best-effort)
  window.addEventListener('deviceorientation', (e)=>{
    if (e.gamma==null || e.beta==null) return;
    const nx = Math.max(-1, Math.min(1, e.gamma/30));
    const ny = Math.max(-1, Math.min(1, e.beta/50));
    targetX = -nx*MAX; targetY = ny*MAX*0.8;
  });
})();

/* ------- Wiring ------- */
document.querySelectorAll('.season-card').forEach(btn=>{
  btn.addEventListener('click', ()=>{ unlockAudio(); loadSeason(btn.dataset.season); });
});
document.getElementById('changeSeasonBtn').addEventListener('click', ()=>{ seasonPicker.style.display='grid'; controls.style.display='none'; });
document.getElementById('toggleControlsBtn').addEventListener('click', ()=>{ controls.style.display = (controls.style.display==='none' || !controls.style.display) ? 'grid' : 'none'; showUI(); });
muteBtn.addEventListener('click', toggleMute);
hotspotDebugBtn.addEventListener('click', ()=>{
  hotspotDebug = !hotspotDebug;
  document.querySelectorAll('.hotspot').forEach(h => hotspotDebug ? h.classList.add('debug') : h.classList.remove('debug'));
});

[rainOn, snowOn, windOn, splashesOn, leavesOn].forEach(el=> el.addEventListener('change', applyWeather));
[rainIntensity, snowIntensity, leavesIntensity].forEach(el=> el.addEventListener('input', applyWeather));
[masterVol, rainVol, fireVol, windVol, birdsVol].forEach(el=> el.addEventListener('input', applyVolumes));
if (fireOn) fireOn.addEventListener('change', ()=> fireOn.checked ? lightFire() : extinguishFire());

window.addEventListener('keydown', (e)=>{
  if (e.key==='m' || e.key==='M') toggleMute();
  if (e.key==='c' || e.key==='C') { controls.style.display = (controls.style.display==='none'||!controls.style.display) ? 'grid' : 'none'; showUI(); }
  if (e.key==='s' || e.key==='S') { document.getElementById('changeSeasonBtn').click(); }
  if (e.key==='h' || e.key==='H') { hotspotDebugBtn.click(); }
});

window.addEventListener('resize', ()=>{
  if (currentCfg?.fireHotspot){
    const hot=document.querySelector('.hotspot'); if(hot) positionHotspot(hot, currentCfg.fireHotspot);
    fireplaceBounds = pctBoxToPx(currentCfg.fireHotspot); placeFireSprite();
  }
  document.querySelectorAll('.window-overlay').forEach((_,i)=> windowTrails[i]?.resize());
  if (currentCfg){ const floorPx = fx.height * (currentCfg.floorY/100); rainFX.setFloorY(floorPx); }
});

/* Show picker first */
seasonPicker.style.display='grid'; controls.style.display='none';
</script>
</body>
</html>
