<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Seasons Ambience</title>
  <meta name="description" content="Interactive ambience — choose a season, weather, and sounds." />
  <style>
    :root{
      --ui-bg: rgba(20,22,24,.55);
      --ui-blur: 14px;
      --ui-border: rgba(255,255,255,.12);
      --ui-text: #f7f7f7;
      --ui-accent: #91d5ff;
      --ui-muted: #b9c0c7;
      --panel-w: min(420px, 92vw);
      --z-scene: 0;
      --z-canvas: 1;
      --z-sprite: 2;
      --z-hotspots: 3;
      --z-ui: 4;
      --z-overlay: 5;
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      color: var(--ui-text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: #0b0e12;
    }

    /* ----- Scene layers ----- */
    #scene {
      position: fixed;
      inset: 0;
      z-index: var(--z-scene);
      background: #0b0e12 center / cover no-repeat;
      transition: filter .35s ease, transform .35s ease;
      will-change: filter, transform;
    }
    /* Vignette overlay */
    #scene::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,var(--vignette, .25)) 100%);
      transition: opacity .3s ease;
      opacity: 1;
    }

    /* Canvas for rain/snow */
    #fx {
      position: fixed;
      inset: 0;
      z-index: var(--z-canvas);
      pointer-events: none;
    }

    /* Fire sprite overlay (shows only when fireplace is lit) */
    #fire-sprite {
      position: fixed;
      z-index: var(--z-sprite);
      width: 0; height: 0; /* will be sized/positioned by JS */
      background-repeat: no-repeat;
      image-rendering: auto;
      display: none;
      pointer-events: none;
      will-change: background-position;
    }

    /* Clickable hotspots for the scene (e.g., fireplace) */
    #hotspots {
      position: fixed; inset: 0;
      z-index: var(--z-hotspots);
      pointer-events: none; /* only hotspots receive clicks */
    }
    .hotspot {
      position: absolute;
      border: 2px dashed transparent;
      border-radius: 8px;
      pointer-events: auto;
      background: transparent;
      padding: 0; margin: 0;
      cursor: pointer;
    }
    .hotspot:focus-visible {
      outline: none;
      border-color: rgba(255,255,255,.7);
    }
    /* Optional debug outline; toggle via JS if you want to see the zone */
    .hotspot.debug { border-color: rgba(255,255,255,.3); }

    /* ----- Season picker overlay ----- */
    #season-picker {
      position: fixed; inset: 0;
      z-index: var(--z-overlay);
      background: linear-gradient(180deg, rgba(6,8,10,0.8), rgba(6,8,10,0.8));
      display: grid;
      place-items: center;
      padding: clamp(20px, 4vw, 40px);
    }
    .picker-panel {
      width: min(920px, 96vw);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      backdrop-filter: blur(var(--ui-blur));
      -webkit-backdrop-filter: blur(var(--ui-blur));
      background: var(--ui-bg);
      border: 1px solid var(--ui-border);
      border-radius: 16px;
      padding: 20px;
    }
    .picker-header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--ui-border);
      gap: 8px;
    }
    .picker-header h1 {
      font-size: clamp(18px, 3vw, 22px);
      margin: 0; font-weight: 650;
      letter-spacing: .2px;
    }
    .picker-grid {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .season-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--ui-border);
      aspect-ratio: 4/3;
      display: flex; align-items: end;
      isolation: isolate;
      cursor: pointer;
      background: #151a1f;
    }
    .season-card img {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      filter: brightness(.9);
      transform: scale(1.02);
      transition: transform .3s ease, filter .3s ease;
      z-index: 0;
    }
    .season-card:hover img { transform: scale(1.06); filter: brightness(1); }
    .season-label {
      position: relative;
      z-index: 1;
      width: 100%;
      padding: 10px 12px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.6));
      font-weight: 650;
      letter-spacing: .3px;
      text-shadow: 0 2px 8px rgba(0,0,0,.6);
    }

    /* ----- Controls panel ----- */
    #controls {
      position: fixed;
      right: 14px; bottom: 14px;
      width: var(--panel-w);
      z-index: var(--z-ui);
      display: grid;
      gap: 10px;
      user-select: none;
    }

    .panel {
      backdrop-filter: blur(var(--ui-blur));
      -webkit-backdrop-filter: blur(var(--ui-blur));
      background: var(--ui-bg);
      border: 1px solid var(--ui-border);
      border-radius: 14px;
      padding: 12px;
    }
    .row { display: flex; align-items: center; gap: 10px; }
    .row.split { justify-content: space-between; }
    .row.wrap { flex-wrap: wrap; }
    .row + .row { margin-top: 8px; }
    .panel h2 {
      margin: 0 0 6px 0; font-size: 14px; font-weight: 700; color: var(--ui-muted);
      letter-spacing: .4px; text-transform: uppercase;
    }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--ui-border);
      padding: 8px 10px;
      border-radius: 24px;
      background: rgba(255,255,255,.04);
    }
    .chip input[type="checkbox"] { accent-color: var(--ui-accent); transform: translateY(1px); }
    .chip .lbl { font-size: 14px; font-weight: 600; }

    .slider-wrap { flex: 1; display: grid; gap: 4px; }
    .slider-wrap label { font-size: 12px; color: var(--ui-muted); }
    input[type="range"] { width: 100%; }
    .small { font-size: 12px; color: var(--ui-muted); }

    /* Top bar */
    #topbar {
      position: fixed; left: 14px; top: 14px; z-index: var(--z-ui);
      display: flex; align-items: center; gap: 8px;
    }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--ui-border);
      padding: 8px 12px;
      border-radius: 24px;
      background: rgba(255,255,255,.06);
      color: var(--ui-text);
      text-decoration: none;
      cursor: pointer;
      font-weight: 650;
    }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }

    /* Loader */
    #loader {
      position: fixed; inset: 0; z-index: var(--z-overlay);
      display: none; place-items: center;
      background: linear-gradient(180deg, rgba(6,8,10,.6), rgba(6,8,10,.6));
    }
    .spinner { width: 46px; height: 46px; border-radius: 50%;
      border: 5px solid rgba(255,255,255,.18); border-top-color: var(--ui-accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive niceties */
    @media (max-width: 720px) {
      #controls { right: 10px; left: 10px; width: auto; }
    }
    @media (prefers-reduced-motion: reduce) {
      .season-card img { transition: none; }
    }
  </style>
</head>
<body>

  <!-- Background scene -->
  <div id="scene" role="img" aria-label="Ambience background"></div>

  <!-- Weather FX canvas -->
  <canvas id="fx"></canvas>

  <!-- Fire sprite (positioned by JS when lit) -->
  <div id="fire-sprite" aria-hidden="true"></div>

  <!-- Clickable hotspots overlay -->
  <div id="hotspots"></div>

  <!-- Top bar -->
  <div id="topbar" class="panel">
    <button id="changeSeasonBtn" class="btn" title="Change season (S)">🌗 Change Season</button>
    <button id="toggleControlsBtn" class="btn" title="Show/Hide controls (C)">🎛 Controls</button>
    <button id="muteBtn" class="btn" title="Mute/Unmute (M)">🔇 Mute</button>
  </div>

  <!-- Controls panel -->
  <div id="controls" style="display:none;">
    <div class="panel">
      <h2>Weather</h2>
      <div class="row wrap">
        <span class="chip"><input id="rainOn" type="checkbox"><span class="lbl">Rain</span></span>
        <span class="chip"><input id="snowOn" type="checkbox"><span class="lbl">Snow</span></span>
        <span class="chip"><input id="windOn" type="checkbox" checked><span class="lbl">Wind</span></span>
        <span id="fireChip" class="chip" style="display:none;"><input id="fireOn" type="checkbox"><span class="lbl">Fireplace</span></span>
      </div>
      <div class="row">
        <div class="slider-wrap">
          <label for="rainIntensity">Rain intensity</label>
          <input id="rainIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div class="slider-wrap">
          <label for="snowIntensity">Snow intensity</label>
          <input id="snowIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Audio Mixer</h2>
      <div class="row">
        <div class="slider-wrap">
          <label for="masterVol">Master</label>
          <input id="masterVol" type="range" min="0" max="100" step="1" value="80">
        </div>
        <div class="slider-wrap">
          <label for="rainVol">Rain</label>
          <input id="rainVol" type="range" min="0" max="100" step="1" value="70">
        </div>
        <div class="slider-wrap">
          <label for="fireVol">Fire</label>
          <input id="fireVol" type="range" min="0" max="100" step="1" value="65">
        </div>
        <div class="slider-wrap">
          <label for="windVol">Wind</label>
          <input id="windVol" type="range" min="0" max="100" step="1" value="45">
        </div>
        <div class="slider-wrap">
          <label for="birdsVol">Birds</label>
          <input id="birdsVol" type="range" min="0" max="100" step="1" value="35">
        </div>
      </div>
      <div class="row small">Tip: Click the fireplace in the scene to light it.</div>
    </div>

    <div class="panel">
      <h2>Visuals</h2>
      <div class="row">
        <div class="slider-wrap">
          <label for="brightness">Brightness</label>
          <input id="brightness" type="range" min="50" max="150" step="1" value="100">
        </div>
        <div class="slider-wrap">
          <label for="warmth">Warmth (cool → warm)</label>
          <input id="warmth" type="range" min="-50" max="50" step="1" value="0">
        </div>
        <div class="slider-wrap">
          <label for="vignette">Vignette</label>
          <input id="vignette" type="range" min="0" max="80" step="1" value="25">
        </div>
      </div>
    </div>
  </div>

  <!-- Season picker (first screen) -->
  <div id="season-picker" aria-modal="true" role="dialog">
    <div class="picker-panel">
      <div class="picker-header">
        <h1>Choose a season to set the ambience</h1>
        <div class="small">You can change this anytime.</div>
      </div>
      <div class="picker-grid">
        <button class="season-card" data-season="winter" title="Winter">
          <img src="assets/winter.jpg" alt="Winter preview">
          <div class="season-label">❄️ Winter</div>
        </button>
        <button class="season-card" data-season="spring" title="Spring">
          <img src="assets/spring.jpg" alt="Spring preview">
          <div class="season-label">🌱 Spring</div>
        </button>
        <button class="season-card" data-season="summer" title="Summer">
          <img src="assets/summer.jpg" alt="Summer preview">
          <div class="season-label">🌞 Summer</div>
        </button>
        <button class="season-card" data-season="fall" title="Fall">
          <img src="assets/fall.jpg" alt="Fall preview">
          <div class="season-label">🍂 Fall</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Loader overlay -->
  <div id="loader"><div class="spinner" aria-hidden="true"></div></div>

  <script>
  // -------------------------------
  // Asset configuration per season
  // -------------------------------
  const SCENES = {
    winter: {
      name: "Winter",
      image: "assets/winter.jpg",  // Replace with your image
      hasFireplace: true,
      // Hotspot in percent of image viewport (adjust to match your image)
      fireHotspot: { x: 68, y: 70, w: 14, h: 22 },
      fireSprite: {
        // Replace with your sprite sheet (e.g., 6 cols x 4 rows)
        url: "sprites/fire_256x256_6x4.png",
        frameW: 256, frameH: 256, cols: 6, rows: 4, fps: 18,
        // On-screen size and offset (percent of viewport) relative to hotspot box:
        scale: 1.0, offsetX: 0, offsetY: 0
      },
      defaults: {
        rainOn: false, snowOn: true, windOn: true, fireOn: false,
        rainIntensity: 0.0, snowIntensity: 0.6,
        volumes: { master: .8, rain: .7, fire: .65, wind: .45, birds: .15 },
        visuals: { brightness: 1.0, warmth: 0.0, vignette: .25 }
      }
    },
    spring: {
      name: "Spring",
      image: "assets/spring.jpg",
      hasFireplace: false,
      fireHotspot: null,
      fireSprite: null,
      defaults: {
        rainOn: true, snowOn: false, windOn: true, fireOn: false,
        rainIntensity: 0.35, snowIntensity: 0.0,
        volumes: { master: .8, rain: .6, fire: 0.0, wind: .35, birds: .55 },
        visuals: { brightness: 1.05, warmth: .1, vignette: .18 }
      }
    },
    summer: {
      name: "Summer",
      image: "assets/summer.jpg",
      hasFireplace: true, // set false if your image lacks a fireplace
      fireHotspot: { x: 55, y: 62, w: 12, h: 18 },
      fireSprite: {
        url: "sprites/fire_256x256_6x4.png",
        frameW: 256, frameH: 256, cols: 6, rows: 4, fps: 20,
        scale: 1.0, offsetX: 0, offsetY: 0
      },
      defaults: {
        rainOn: false, snowOn: false, windOn: true, fireOn: false,
        rainIntensity: 0.0, snowIntensity: 0.0,
        volumes: { master: .75, rain: .0, fire: .55, wind: .25, birds: .5 },
        visuals: { brightness: 1.05, warmth: .2, vignette: .12 }
      }
    },
    fall: {
      name: "Fall",
      image: "assets/fall.jpg",
      hasFireplace: true,
      fireHotspot: { x: 64, y: 68, w: 16, h: 20 },
      fireSprite: {
        url: "sprites/fire_256x256_6x4.png",
        frameW: 256, frameH: 256, cols: 6, rows: 4, fps: 18,
        scale: 1.05, offsetX: 0, offsetY: 0
      },
      defaults: {
        rainOn: true, snowOn: false, windOn: true, fireOn: false,
        rainIntensity: 0.25, snowIntensity: 0.0,
        volumes: { master: .8, rain: .5, fire: .6, wind: .4, birds: .2 },
        visuals: { brightness: 1.0, warmth: .1, vignette: .22 }
      }
    }
  };

  // -------------------------------
  // Audio setup
  // -------------------------------
  const AUDIO = {
    rain:  new Audio("audio/rain.mp3"),     // loopable soft rain
    fire:  new Audio("audio/fire_crackle.mp3"),
    wind:  new Audio("audio/wind.mp3"),
    birds: new Audio("audio/birds.mp3")
  };
  for (const a of Object.values(AUDIO)) {
    a.loop = true;
    a.preload = "auto";
    a.volume = 0;
  }
  let masterVolume = 0.8;
  let globalMuted = false;

  function setTrackVolume(track, v){
    const a = AUDIO[track]; if(!a) return;
    a.volume = Math.max(0, Math.min(1, v)) * masterVolume * (globalMuted ? 0 : 1);
    if (a.volume > 0 && a.paused) { a.play().catch(()=>{}); }
    if (a.volume === 0 && !a.paused) { /* keep playing silently to avoid gaps */ }
  }
  function setAllVolumes(vols){
    setTrackVolume('rain',  vols.rain  ?? 0);
    setTrackVolume('fire',  vols.fire  ?? 0);
    setTrackVolume('wind',  vols.wind  ?? 0);
    setTrackVolume('birds', vols.birds ?? 0);
  }

  // -------------------------------
  // Weather FX (Canvas): Rain & Snow
  // -------------------------------
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let running = true;

  // Resize canvas to viewport
  function resizeCanvas(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    fx.width  = Math.floor(window.innerWidth  * DPR);
    fx.height = Math.floor(window.innerHeight * DPR);
  }
  window.addEventListener('resize', resizeCanvas, { passive: true });
  resizeCanvas();

  // Rain
  class RainSystem {
    constructor(){ this.drops=[]; this.intensity=0; this.wind=0.6; }
    setIntensity(f){ this.intensity = Math.max(0, Math.min(1, f)); }
    update(){
      const target = Math.floor(this.intensity * 700); // max drops (tune)
      while (this.drops.length < target) this.spawn();
      if (this.drops.length > target) this.drops.splice(target);
      const W=fx.width, H=fx.height;
      for (let d of this.drops){
        d.x += d.vx; d.y += d.vy;
        if (d.y > H || d.x < -50*DPR || d.x > W+50*DPR) this.recycle(d);
      }
    }
    draw(){
      if (this.intensity < 0.02) return;
      ctx.save();
      ctx.lineCap = 'round';
      ctx.globalAlpha = 0.45;
      ctx.strokeStyle = '#bcd7ff';
      for (let d of this.drops){
        ctx.lineWidth = d.w;
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x - d.vx*0.6, d.y - d.vy*0.6);
        ctx.stroke();
      }
      ctx.restore();
    }
    spawn(){
      const W=fx.width, H=fx.height;
      const speed = 14*DPR + Math.random()*10*DPR;
      const angle = Math.PI*(1.2 + Math.random()*0.15); // slant
      const vx = Math.cos(angle)*speed*(1+this.wind*0.5);
      const vy = Math.sin(angle)*speed;
      const x = Math.random()*(W+100*DPR)-50*DPR;
      const y = -Math.random()*H*0.2;
      const w = Math.random()*0.9*DPR + 0.6*DPR;
      this.drops.push({x,y,vx,vy,w});
    }
    recycle(d){
      const W=fx.width;
      d.x = Math.random()*(W+100*DPR)-50*DPR;
      d.y = -20*DPR;
    }
  }

  // Snow
  class SnowSystem {
    constructor(){ this.flakes=[]; this.intensity=0; this.tick=0; }
    setIntensity(f){ this.intensity = Math.max(0, Math.min(1, f)); }
    update(){
      const target = Math.floor(this.intensity * 400);
      while (this.flakes.length < target) this.spawn();
      if (this.flakes.length > target) this.flakes.splice(target);
      const W=fx.width, H=fx.height;
      this.tick += 0.002;
      for (let fl of this.flakes){
        fl.t += fl.tw;
        fl.x += Math.sin(fl.t)*fl.swing + fl.wind;
        fl.y += fl.vy;
        if (fl.y > H) this.recycle(fl);
        if (fl.x < -50*DPR) fl.x = W+50*DPR;
        if (fl.x > W+50*DPR) fl.x = -50*DPR;
      }
    }
    draw(){
      if (this.intensity < 0.02) return;
      ctx.save();
      for (let fl of this.flakes){
        const r=fl.r, x=fl.x, y=fl.y;
        const grd = ctx.createRadialGradient(x,y,0,x,y,r);
        grd.addColorStop(0,'rgba(255,255,255,.95)');
        grd.addColorStop(1,'rgba(255,255,255,0)');
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(x,y,r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
    spawn(){
      const W=fx.width, H=fx.height;
      const r = (Math.random()*1.8 + 0.8) * DPR;
      const vy = (Math.random()*0.6 + 0.4) * DPR;
      const swing = (Math.random()*1.3 + 0.4) * DPR;
      const wind = (Math.random()*0.30 - 0.15) * DPR;
      const tw = Math.random()*0.05 + 0.015;
      const x = Math.random()*W, y = -Math.random()*H*0.2;
      this.flakes.push({x,y,r,vy,swing,wind,tw,t:Math.random()*Math.PI*2});
    }
    recycle(f){
      const W=fx.width;
      f.x = Math.random()*W; f.y = -10*DPR;
      f.t = Math.random()*Math.PI*2;
    }
  }

  const rainFX = new RainSystem();
  const snowFX = new SnowSystem();

  // Main render loop
  function loop(){
    if (!running) return;
    ctx.clearRect(0,0,fx.width,fx.height);
    rainFX.update(); snowFX.update();
    rainFX.draw();   snowFX.draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // -------------------------------
  // Fire sprite animator
  // -------------------------------
  class FireSprite {
    constructor(el){ this.el = el; this.cfg=null; this.frame=0; this.timer=null; this.total=0; this.lit=false; }
    load(cfg){
      this.cfg = cfg; this.frame=0;
      this.total = cfg.cols * cfg.rows;
      this.el.style.backgroundImage = `url('${cfg.url}')`;
      this.el.style.width  = cfg.frameW + 'px';
      this.el.style.height = cfg.frameH + 'px';
      this.el.style.backgroundSize = `${cfg.cols*100}% ${cfg.rows*100}%`;
    }
    place(px,py,scale=1){ // px/py in CSS pixels; positions top-left
      this.el.style.left = px + 'px';
      this.el.style.top  = py + 'px';
      this.el.style.transform = `translate(-50%,-50%) scale(${scale})`;
    }
    start(){
      if (!this.cfg) return;
      this.lit = true;
      this.el.style.display = 'block';
      const step = () => {
        this.frame = (this.frame + 1) % this.total;
        const c = this.frame % this.cfg.cols;
        const r = Math.floor(this.frame / this.cfg.cols);
        const posX = (c / (this.cfg.cols-1)) * 100;
        const posY = (r / (this.cfg.rows-1)) * 100;
        this.el.style.backgroundPosition = `${posX}% ${posY}%`;
        this.timer = setTimeout(step, 1000/this.cfg.fps);
      };
      step();
    }
    stop(){
      this.lit = false;
      this.el.style.display = 'none';
      if (this.timer) { clearTimeout(this.timer); this.timer=null; }
    }
  }
  const fireSprite = new FireSprite(document.getElementById('fire-sprite'));

  // -------------------------------
  // UI wiring & state
  // -------------------------------
  const $ = sel => document.querySelector(sel);
  const sceneEl = $('#scene');
  const hotspotsEl = $('#hotspots');

  const seasonPicker = $('#season-picker');
  const loader = $('#loader');
  const controls = $('#controls');
  const fireChip = $('#fireChip');

  const rainOn = $('#rainOn'), snowOn = $('#snowOn'), windOn = $('#windOn'), fireOn = $('#fireOn');
  const rainIntensity = $('#rainIntensity'), snowIntensity = $('#snowIntensity');

  const masterVol = $('#masterVol'), rainVol = $('#rainVol'), fireVol = $('#fireVol'), windVol = $('#windVol'), birdsVol = $('#birdsVol');
  const brightness = $('#brightness'), warmth = $('#warmth'), vignette = $('#vignette');

  const changeSeasonBtn = $('#changeSeasonBtn'), toggleControlsBtn = $('#toggleControlsBtn'), muteBtn = $('#muteBtn');

  let currentSeasonKey = null;
  let currentCfg = null;
  let fireplaceBounds = null; // {left,top,width,height} in CSS pixels

  // Persistence helpers
  const STORE_KEY = 'ambience.settings.v1';
  function saveSettings(){
    try {
      const data = {
        season: currentSeasonKey,
        rainOn: rainOn.checked, snowOn: snowOn.checked, windOn: windOn.checked, fireOn: fireOn.checked,
        rainIntensity: +rainIntensity.value/100, snowIntensity: +snowIntensity.value/100,
        volumes: {
          master: +masterVol.value/100, rain: +rainVol.value/100, fire: +fireVol.value/100,
          wind: +windVol.value/100, birds: +birdsVol.value/100
        },
        visuals: {
          brightness: +brightness.value/100, warmth: +warmth.value/100, vignette: +vignette.value/100
        },
        muted: globalMuted
      };
      localStorage.setItem(STORE_KEY, JSON.stringify(data));
    } catch {}
  }
  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(STORE_KEY)); } catch { return null; }
  }

  function showLoader(flag){ loader.style.display = flag ? 'grid' : 'none'; }

  // Season loading
  async function loadSeason(key){
    currentSeasonKey = key;
    currentCfg = SCENES[key];
    showLoader(true);

    // Preload background
    await new Promise(res=>{
      const img = new Image();
      img.onload = res; img.onerror = res;
      img.src = currentCfg.image;
    });
    sceneEl.style.backgroundImage = `url('${currentCfg.image}')`;
    sceneEl.setAttribute('aria-label', `${currentCfg.name} ambience background`);

    // Configure fireplace/hotspot
    hotspotsEl.innerHTML = '';
    fireplaceBounds = null;
    if (currentCfg.hasFireplace && currentCfg.fireHotspot) {
      const hot = document.createElement('button');
      hot.className = 'hotspot'; // add 'debug' to see the clickable region
      hot.setAttribute('aria-label','Toggle fireplace');
      hotspotsEl.appendChild(hot);
      positionHotspot(hot, currentCfg.fireHotspot);
      hot.addEventListener('click', ()=> toggleFire());
      fireChip.style.display = '';
      fireOn.checked = false;
      // Prepare sprite
      if (currentCfg.fireSprite) fireSprite.load(currentCfg.fireSprite);
      // Keep track of absolute bounds for sprite placement
      fireplaceBounds = getHotspotBoundsPx(currentCfg.fireHotspot);
      placeFireSprite();
    } else {
      fireChip.style.display = 'none';
      fireOn.checked = false;
      fireSprite.stop();
    }

    // Apply defaults (or restore saved)
    const saved = loadSettings();
    const def = currentCfg.defaults;
    const v = (saved && saved.season===key) ? saved : null;

    rainOn.checked  = v ? v.rainOn  : def.rainOn;
    snowOn.checked  = v ? v.snowOn  : def.snowOn;
    windOn.checked  = v ? v.windOn  : def.windOn;
    fireOn.checked  = v ? v.fireOn  : def.fireOn;

    rainIntensity.value = Math.round(100*(v ? v.rainIntensity : def.rainIntensity));
    snowIntensity.value = Math.round(100*(v ? v.snowIntensity : def.snowIntensity));

    masterVol.value = Math.round(100*(v ? v.volumes.master : def.volumes.master));
    rainVol.value   = Math.round(100*(v ? v.volumes.rain   : def.volumes.rain));
    fireVol.value   = Math.round(100*(v ? v.volumes.fire   : def.volumes.fire));
    windVol.value   = Math.round(100*(v ? v.volumes.wind   : def.volumes.wind));
    birdsVol.value  = Math.round(100*(v ? v.volumes.birds  : def.volumes.birds));

    brightness.value = Math.round(100*(v ? v.visuals.brightness : def.visuals.brightness));
    warmth.value     = Math.round(100*((v ? v.visuals.warmth : def.visuals.warmth)));
    vignette.value   = Math.round(100*(v ? v.visuals.vignette : def.visuals.vignette));

    globalMuted = v ? !!v.muted : false;
    updateMuteButton();

    applyWeather();
    applyVolumes();
    applyVisuals();

    // Auto-start fireplace if set + available
    if (fireOn.checked && currentCfg.hasFireplace) lightFire(); else extinguishFire();

    showLoader(false);
    controls.style.display = 'grid';
    seasonPicker.style.display = 'none';
  }

  // Position a hotspot according to % in viewport (image covers viewport)
  function positionHotspot(el, pct){
    const rect = getHotspotBoundsPx(pct);
    el.style.left = rect.left + 'px';
    el.style.top  = rect.top  + 'px';
    el.style.width  = rect.width  + 'px';
    el.style.height = rect.height + 'px';
  }
  function getHotspotBoundsPx(pct){
    const vw = window.innerWidth, vh = window.innerHeight;
    const left = vw * (pct.x/100), top = vh * (pct.y/100);
    const width = vw * (pct.w/100), height = vh * (pct.h/100);
    return { left, top, width, height };
  }

  function placeFireSprite(){
    if (!fireplaceBounds || !currentCfg.fireSprite) return;
    const { left, top, width, height } = fireplaceBounds;
    const cx = left + width/2 + (currentCfg.fireSprite.offsetX || 0);
    const cy = top  + height/2 + (currentCfg.fireSprite.offsetY || 0);
    const scale = currentCfg.fireSprite.scale || 1;
    fireSprite.place(cx, cy, scale);
  }
  window.addEventListener('resize', ()=>{
    if (currentCfg && currentCfg.fireHotspot) {
      positionHotspot(document.querySelector('.hotspot'), currentCfg.fireHotspot);
      fireplaceBounds = getHotspotBoundsPx(currentCfg.fireHotspot);
      placeFireSprite();
    }
  });

  // Weather toggles & intensities
  function applyWeather(){
    rainFX.setIntensity(rainOn.checked ? (+rainIntensity.value/100) : 0);
    snowFX.setIntensity(snowOn.checked ? (+snowIntensity.value/100) : 0);
    // Wind is audio only here
    setTrackVolume('wind', windOn.checked ? (+windVol.value/100) : 0);
    // If rain is on, ensure some rain audio even at low intensity (tied to rainVol)
    setTrackVolume('rain', (rainOn.checked ? (+rainVol.value/100) : 0) * Math.max(.25, +rainIntensity.value/100));
    saveSettings();
  }

  // Audio volumes
  function applyVolumes(){
    masterVolume = +masterVol.value/100;
    setTrackVolume('rain',  (rainOn.checked ? +rainVol.value/100 : 0) * Math.max(.25, +rainIntensity.value/100));
    setTrackVolume('fire',  fireOn.checked ? +fireVol.value/100 : 0);
    setTrackVolume('wind',  windOn.checked ? +windVol.value/100 : 0);
    setTrackVolume('birds', +birdsVol.value/100);
    saveSettings();
  }

  // Visuals via CSS filters
  function applyVisuals(){
    const b = +brightness.value/100;
    const w = +warmth.value/100; // -0.5..0.5
    const vig = +vignette.value/100;
    // Approximate warmth: sepia + slight hue shift + saturation
    // Positive warmth -> warmer; negative -> cooler
    const sepia = Math.max(0, w)*0.6;
    const hue   = (w<0 ? -6 : 6) * Math.abs(w); // small nudge
    const sat   = 1 + Math.abs(w)*0.25;
    sceneEl.style.filter = `brightness(${b}) saturate(${sat}) sepia(${sepia}) hue-rotate(${hue}deg)`;
    sceneEl.style.setProperty('--vignette', vig);
    saveSettings();
  }

  // Fireplace controls
  function lightFire(){
    if (!currentCfg || !currentCfg.hasFireplace) return;
    fireOn.checked = true;
    if (currentCfg.fireSprite) fireSprite.start();
    setTrackVolume('fire', +fireVol.value/100);
    saveSettings();
  }
  function extinguishFire(){
    fireOn.checked = false;
    fireSprite.stop();
    setTrackVolume('fire', 0);
    saveSettings();
  }
  function toggleFire(){ fireOn.checked ? extinguishFire() : lightFire(); }

  // Mute
  function updateMuteButton(){
    muteBtn.textContent = globalMuted ? '🔊 Unmute' : '🔇 Mute';
    applyVolumes();
  }
  function toggleMute(){ globalMuted = !globalMuted; updateMuteButton(); saveSettings(); }

  // Controls toggle
  function toggleControls(){
    controls.style.display = (controls.style.display==='none' || !controls.style.display) ? 'grid' : 'none';
  }

  // Event wiring
  document.querySelectorAll('.season-card').forEach(btn=>{
    btn.addEventListener('click', ()=> loadSeason(btn.dataset.season));
  });
  changeSeasonBtn.addEventListener('click', ()=>{
    seasonPicker.style.display = 'grid';
    controls.style.display = 'none';
  });
  toggleControlsBtn.addEventListener('click', toggleControls);
  muteBtn.addEventListener('click', toggleMute);

  [rainOn, snowOn, windOn].forEach(el => el.addEventListener('change', applyWeather));
  [rainIntensity, snowIntensity].forEach(el => el.addEventListener('input', applyWeather));

  [masterVol, rainVol, fireVol, windVol, birdsVol].forEach(el => el.addEventListener('input', applyVolumes));

  [brightness, warmth, vignette].forEach(el => el.addEventListener('input', applyVisuals));

  if (fireOn) fireOn.addEventListener('change', ()=> fireOn.checked ? lightFire() : extinguishFire());

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if (e.key==='m' || e.key==='M') toggleMute();
    if (e.key==='c' || e.key==='C') toggleControls();
    if (e.key==='s' || e.key==='S') { changeSeasonBtn.click(); }
  });

  // Auto-load last used season if available
  (function boot(){
    const saved = loadSettings();
    if (saved && SCENES[saved.season]) {
      loadSeason(saved.season);
    } else {
      // show picker by default
      seasonPicker.style.display = 'grid';
    }
  })();
  </script>
</body>
</html>
