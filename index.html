<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Seasons Ambience</title>
<meta name="description" content="Interactive ambience ‚Äî choose a season, weather, day/night cycle, props, and per-season elements like a picnic."/>
<style>
  :root{
    --ui-bg: rgba(20,22,24,.55);
    --ui-blur: 14px;
    --ui-border: rgba(255,255,255,.12);
    --ui-text: #f7f7f7;
    --ui-accent: #91d5ff;
    --ui-muted: #b9c0c7;
    --panel-w: min(420px, 92vw);
    --z-scene: 0;
    --z-canvas: 1;
    --z-overlays: 2;
    --z-sprite: 3;
    --z-hotspots: 4;
    --z-ui: 5;
    --z-overlay: 6;
    /* NEW: global zoom of the image stack (1 = fit; <1 = zoomed out) */
    --bg-scale: 0.94;
  }

  *{ box-sizing: border-box; }
  html, body { height:100%; margin:0; background:#0b0e12; color:var(--ui-text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

  /* Scene container (no background-image any more; we use real <img> layers) */
  #scene { position:fixed; inset:0; z-index:var(--z-scene); transition: filter .35s ease, transform .35s ease; will-change:filter,transform; }
  #scene::after { content:""; position:absolute; inset:0; pointer-events:none;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,var(--vignette,.25)) 100%);
  }

  /* NEW: stacked image layers */
  #bgRoot { position:absolute; inset:0; overflow:hidden; }
  #bgScale { position:absolute; inset:0; transform: scale(var(--bg-scale)); transform-origin:center center; }
  .bg-img { position:absolute; inset:0; width:100%; height:100%; object-fit: contain;
    user-select:none; pointer-events:none; image-rendering:auto; }
  /* overlay images fade */
  .bg-overlay { opacity:0; transition: opacity 120ms ease-in-out; }
  .bg-overlay.on { opacity:1; }

  /* FX canvas (rain/snow/leaves) */
  #fx { position:fixed; inset:0; z-index:var(--z-canvas); pointer-events:none; }

  /* Overlays for lamp glows & window canvases */
  #overlays { position:fixed; inset:0; z-index:var(--z-overlays); pointer-events:none; }
  .lamp-glow { position:fixed; width:300px; height:300px; left:50%; top:50%;
    transform:translate(-50%,-50%); border-radius:50%; mix-blend-mode:screen; pointer-events:none;
    animation: lampFlicker 1.8s infinite steps(6, end); }
  @keyframes lampFlicker { 0%{filter:brightness(.95);} 50%{filter:brightness(1.05);} 100%{filter:brightness(.95);} }
  .window-overlay { position:fixed; pointer-events:none; }

  /* Fire sprite */
  #fire-sprite { position:fixed; z-index:var(--z-sprite); width:0; height:0; display:none;
    background-repeat:no-repeat; image-rendering:auto; pointer-events:none; will-change:background-position; }

  /* Hotspots */
  #hotspots { position:fixed; inset:0; z-index:var(--z-hotspots); pointer-events:none; }
  .hotspot { position:absolute; pointer-events:auto; cursor:pointer; background:transparent;
    border:2px dashed transparent; border-radius:8px; }
  .hotspot:focus-visible { outline:none; border-color:rgba(255,255,255,.7); }
  .hotspot.debug { border-color: rgba(255,255,255,.35); }

  /* Season picker */
  #season-picker { position:fixed; inset:0; z-index:var(--z-overlay);
    background:linear-gradient(180deg, rgba(6,8,10,.85), rgba(6,8,10,.85));
    display:grid; place-items:center; padding:clamp(20px,4vw,40px); }
  .picker-panel { width:min(920px,96vw); display:grid; gap:16px;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    backdrop-filter:blur(var(--ui-blur)); -webkit-backdrop-filter:blur(var(--ui-blur));
    background:var(--ui-bg); border:1px solid var(--ui-border); border-radius:16px; padding:20px; }
  .picker-header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;
    padding-bottom:8px; border-bottom:1px solid var(--ui-border); gap:8px; }
  .picker-header h1 { font-size:clamp(18px,3vw,22px); margin:0; font-weight:650; }
  .picker-grid { grid-column:1/-1; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .season-card { position:relative; border-radius:12px; overflow:hidden; border:1px solid var(--ui-border);
    aspect-ratio:4/3; display:flex; align-items:end; isolation:isolate; cursor:pointer; background:#151a1f; }
  .season-card img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    filter:brightness(.9); transform:scale(1.02); transition:transform .3s ease, filter .3s ease; z-index:0; }
  .season-card:hover img { transform:scale(1.06); filter:brightness(1); }
  .season-label { position:relative; z-index:1; width:100%; padding:10px 12px;
    background:linear-gradient(180deg, transparent, rgba(0,0,0,.6));
    font-weight:650; letter-spacing:.3px; text-shadow:0 2px 8px rgba(0,0,0,.6); }

  /* Top bar + controls */
  #topbar { position:fixed; left:14px; top:14px; z-index:var(--z-ui); display:flex; gap:8px; }
  .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--ui-border);
    padding:8px 12px; border-radius:24px; background:rgba(255,255,255,.06);
    color:var(--ui-text); text-decoration:none; cursor:pointer; font-weight:650; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }

  #controls { position:fixed; right:14px; bottom:14px; width:var(--panel-w); z-index:var(--z-ui); display:grid; gap:10px; user-select:none; }
  .panel { backdrop-filter:blur(var(--ui-blur)); -webkit-backdrop-filter:blur(var(--ui-blur));
    background:var(--ui-bg); border:1px solid var(--ui-border); border-radius:14px; padding:12px; }
  .panel h2 { margin:0 0 6px 0; font-size:14px; font-weight:700; color:var(--ui-muted); letter-spacing:.4px; text-transform:uppercase; }
  .row { display:flex; align-items:center; gap:10px; }
  .row.wrap { flex-wrap:wrap; }
  .row + .row { margin-top:8px; }
  .chip { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--ui-border);
    padding:8px 10px; border-radius:24px; background:rgba(255,255,255,.04); }
  .chip input[type="checkbox"] { accent-color:var(--ui-accent); transform:translateY(1px); }
  .chip .lbl { font-size:14px; font-weight:600; }
  .slider-wrap { flex:1; display:grid; gap:4px; }
  .slider-wrap label { font-size:12px; color:var(--ui-muted); }
  input[type="range"]{ width:100%; }
  .small { font-size:12px; color:var(--ui-muted); }

  /* Loader */
  #loader{ position:fixed; inset:0; z-index:var(--z-overlay); display:none; place-items:center;
    background:linear-gradient(180deg, rgba(6,8,10,.6), rgba(6,8,10,.6)); }
  .spinner{ width:46px; height:46px; border-radius:50%; border:5px solid rgba(255,255,255,.18);
    border-top-color:var(--ui-accent); animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  @media (max-width: 720px){ #controls{ right:10px; left:10px; width:auto; } }
  @media (prefers-reduced-motion: reduce){ .season-card img{ transition:none; } }
</style>
</head>
<body>

  <!-- Scene behind everything -->
  <div id="scene" role="img" aria-label="Ambience background">
    <!-- NEW: real image layers -->
    <div id="bgRoot">
      <div id="bgScale">
        <img id="baseImg" class="bg-img" alt="">
        <!-- overlay images (e.g., picnic) will be appended here as <img class="bg-img bg-overlay"> -->
      </div>
    </div>
  </div>

  <!-- Global particle canvas (rain/snow/leaves) -->
  <canvas id="fx"></canvas>

  <!-- Overlays (lamp glows, window canvases, etc.) -->
  <div id="overlays"></div>

  <!-- Fire sprite -->
  <div id="fire-sprite" aria-hidden="true"></div>

  <!-- Hotspots -->
  <div id="hotspots"></div>

  <!-- Top bar -->
  <div id="topbar" class="panel">
    <button id="changeSeasonBtn" class="btn" title="Change season (S)">üåó Change Season</button>
    <button id="toggleControlsBtn" class="btn" title="Show/Hide controls (C)">üéõ Controls</button>
    <button id="muteBtn" class="btn" title="Mute/Unmute (M)">üîá Mute</button>
    <button id="hotspotDebugBtn" class="btn" title="Show/Hide hotspot boxes (H)">üß™ Hotspots</button>
  </div>

  <!-- Controls -->
  <div id="controls" style="display:none;">

    <!-- Scene elements (per-season overlays like Picnic) -->
    <div id="elementsPanel" class="panel" style="display:none;">
      <h2>Scene elements</h2>
      <div id="elementsList" class="row wrap"></div>
      <div class="row small">These are visual overlays aligned to the base image and fade in/out.</div>
    </div>

    <div class="panel">
      <h2>Weather</h2>
      <div class="row wrap">
        <span id="rainChip"     class="chip"><input id="rainOn" type="checkbox"><span class="lbl">Rain</span></span>
        <span id="snowChip"     class="chip"><input id="snowOn" type="checkbox"><span class="lbl">Snow</span></span>
        <span                   class="chip"><input id="windOn" type="checkbox" checked><span class="lbl">Wind</span></span>
        <span id="splashesChip" class="chip"><input id="splashesOn" type="checkbox" checked><span class="lbl">Rain splashes</span></span>
        <span id="leavesChip"   class="chip"><input id="leavesOn" type="checkbox"><span class="lbl">Autumn leaves</span></span>
        <span id="fireChip"     class="chip" style="display:none;"><input id="fireOn" type="checkbox"><span class="lbl">Fireplace</span></span>
      </div>
      <div class="row">
        <div id="rainWrap"   class="slider-wrap">
          <label for="rainIntensity">Rain intensity</label>
          <input id="rainIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div id="snowWrap"   class="slider-wrap">
          <label for="snowIntensity">Snow intensity</label>
          <input id="snowIntensity" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div id="leavesWrap" class="slider-wrap">
          <label for="leavesIntensity">Leaves intensity</label>
          <input id="leavesIntensity" type="range" min="0" max="100" step="1" value="40">
        </div>
      </div>
      <div class="row small">If rain splashes look off, tweak each scene‚Äôs <code>floorY</code> (% from top).</div>
    </div>

    <div class="panel">
      <h2>Audio Mixer</h2>
      <div class="row">
        <div class="slider-wrap"><label for="masterVol">Master</label><input id="masterVol" type="range" min="0" max="100" step="1" value="80"></div>
        <div class="slider-wrap"><label for="rainVol">Rain</label><input id="rainVol" type="range" min="0" max="100" step="1" value="70"></div>
        <div class="slider-wrap"><label for="fireVol">Fire</label><input id="fireVol" type="range" min="0" max="100" step="1" value="65"></div>
        <div class="slider-wrap"><label for="windVol">Wind</label><input id="windVol" type="range" min="0" max="100" step="1" value="45"></div>
        <div class="slider-wrap"><label for="birdsVol">Birds</label><input id="birdsVol" type="range" min="0" max="100" step="1" value="35"></div>
      </div>
    </div>

    <div class="panel">
      <h2>Visuals</h2>
      <div class="row wrap">
        <span class="chip"><input id="cycleOn" type="checkbox" checked><span class="lbl">24h cycle</span></span>
      </div>
      <div class="row">
        <div class="slider-wrap"><label for="brightness">Brightness</label><input id="brightness" type="range" min="50" max="150" step="1" value="100"></div>
        <div class="slider-wrap"><label for="warmth">Warmth (cool ‚Üí warm)</label><input id="warmth" type="range" min="-50" max="50" step="1" value="0"></div>
        <div class="slider-wrap"><label for="vignette">Vignette</label><input id="vignette" type="range" min="0" max="80" step="1" value="25"></div>
      </div>
    </div>
  </div>

  <!-- Season picker -->
  <div id="season-picker" aria-modal="true" role="dialog">
    <div class="picker-panel">
      <div class="picker-header">
        <h1>Choose a season to set the ambience</h1>
        <div class="small">You can change this anytime.</div>
      </div>
      <div class="picker-grid">
        <button class="season-card" data-season="winter" title="Winter">
          <img src="assets/winter.jpg" alt="Winter preview"><div class="season-label">‚ùÑÔ∏è Winter</div>
        </button>
        <button class="season-card" data-season="spring" title="Spring">
          <img src="assets/spring.jpg" alt="Spring preview"><div class="season-label">üå± Spring</div>
        </button>
        <button class="season-card" data-season="summer" title="Summer">
          <img src="assets/summer.jpg" alt="Summer preview"><div class="season-label">üåû Summer</div>
        </button>
        <button class="season-card" data-season="fall" title="Fall">
          <img src="assets/fall.jpg" alt="Fall preview"><div class="season-label">üçÇ Fall</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader"><div class="spinner" aria-hidden="true"></div></div>

<script>
/* ===========================================================
   SCENES (same as before, but overlays render as <img> layers)
   =========================================================== */
const SCENES = {
  winter: {
    name: "Winter",
    image: "assets/winter.jpg",
    hasFireplace: true,
    fireHotspot: { x: 68, y: 70, w: 14, h: 22 },
    fireSprite: { url: "sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:18, scale:1.0, offsetX:0, offsetY:0 },
    floorY: 92,
    allow: { rain: false, snow: true,  leaves: false },
    props: [ /* add if needed */ ],
    overlays: [],
    defaults: {
      rainOn:false, snowOn:true,  windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.0, snowIntensity:0.55,
      volumes:{ master:.8, rain:.7, fire:.65, wind:.45, birds:.15 },
      visuals:{ brightness:1.0, warmth:0.0, vignette:.25, cycleOn:true }
    }
  },
  spring: {
    name: "Spring",
    image: "assets/spring.jpg",
    hasFireplace:false,
    fireHotspot:null, fireSprite:null,
    floorY: 90,
    allow: { rain: true, snow: false, leaves: false },
    props: [ /* add if needed */ ],
    overlays: [],
    defaults: {
      rainOn:true, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.4, snowIntensity:0.0,
      volumes:{ master:.8, rain:.6, fire:0.0, wind:.35, birds:.55 },
      visuals:{ brightness:1.05, warmth:.1, vignette:.18, cycleOn:true }
    }
  },
  summer: {
    name: "Summer",
    image: "assets/summer.jpg",
    hasFireplace:true,
    fireHotspot:{ x:55, y:62, w:12, h:18 },
    fireSprite:{ url:"sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:20, scale:1.0, offsetX:0, offsetY:0 },
    floorY: 91,
    allow: { rain: false, snow: false, leaves: false },
    props: [ /* add if needed */ ],
    overlays: [
      { key:"picnic", label:"Picnic", url:"assets/summer_picnic.png", default:false }
    ],
    defaults: {
      rainOn:false, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:false, leavesIntensity:0.0,
      rainIntensity:0.0, snowIntensity:0.0,
      volumes:{ master:.75, rain:.0, fire:.55, wind:.25, birds:.5 },
      visuals:{ brightness:1.05, warmth:.2, vignette:.12, cycleOn:true }
    }
  },
  fall: {
    name: "Fall",
    image: "assets/fall.jpg",
    hasFireplace:true,
    fireHotspot:{ x:64, y:68, w:16, h:20 },
    fireSprite:{ url:"sprites/fire_256x256_6x4.png", frameW:256, frameH:256, cols:6, rows:4, fps:18, scale:1.05, offsetX:0, offsetY:0 },
    floorY: 92,
    allow: { rain: true, snow: false, leaves: true },
    props: [ /* add if needed */ ],
    overlays: [],
    defaults: {
      rainOn:true, snowOn:false, windOn:true, splashesOn:true, fireOn:false,
      leavesOn:true, leavesIntensity:0.5,
      rainIntensity:0.28, snowIntensity:0.0,
      volumes:{ master:.8, rain:.5, fire:.6, wind:.4, birds:.2 },
      visuals:{ brightness:1.0, warmth:.1, vignette:.22, cycleOn:true }
    }
  }
};

/* ===================== AUDIO ===================== */
const AUDIO = {
  rain:  new Audio("audio/rain.mp3"),
  fire:  new Audio("audio/fire_crackle.mp3"),
  wind:  new Audio("audio/wind.mp3"),
  birds: new Audio("audio/birds.mp3")
};
for (const a of Object.values(AUDIO)) { a.loop = true; a.preload = "auto"; a.volume = 0; }
let masterVolume = 0.8, globalMuted = false, audioUnlocked = false;
function unlockAudio(){ if (audioUnlocked) return; audioUnlocked = true;
  Object.values(AUDIO).forEach(a=>{ try { a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});} catch {} });
}
function setTrackVolume(track, v){
  const a = AUDIO[track]; if(!a) return;
  const vol = Math.max(0, Math.min(1, v)) * masterVolume * (globalMuted ? 0 : 1);
  a.volume = vol; if (vol>0 && a.paused) { a.play().catch(()=>{}); }
}

/* ===================== CANVAS, WIND, RAIN/SNOW/LEAVES ===================== */
const fx = document.getElementById('fx');
const ctx = fx.getContext('2d');
let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resizeCanvas(){ DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  fx.width = Math.floor(window.innerWidth*DPR); fx.height = Math.floor(window.innerHeight*DPR);
}
window.addEventListener('resize', resizeCanvas, { passive:true }); resizeCanvas();
const clamp01 = v => Math.max(0, Math.min(1, v));

const gust = { t: 0, val: 0 };
function updateGust(windOn) {
  gust.t += 0.003; const base = windOn ? 0.9 : 0.25;
  const wave = Math.sin(gust.t*3.2)*0.4 + Math.sin(gust.t*1.3+1.2)*0.25;
  gust.val = (base + wave) * DPR;
}

/* Splashes */
class SplashSystem {
  constructor(){ this.jets=[]; this.ripples=[]; this.enabled=true; this.floorYpx = fx.height*0.92; }
  setEnabled(on){ this.enabled = on; } setFloorY(yPx){ this.floorYpx = yPx; }
  spawn(x, strength=1){ if (!this.enabled) return;
    const n=3+Math.floor(Math.random()*3);
    for (let i=0;i<n;i++){ const a=(Math.random()*Math.PI/3)+Math.PI/3;
      const speed=(3+Math.random()*3)*strength*DPR;
      const vx=Math.cos(a)*speed*(Math.random()<0.5?-1:1)*0.55;
      const vy=-Math.abs(Math.sin(a)*speed*1.15);
      this.jets.push({ x, y:this.floorYpx-1, vx, vy, life:1, decay:0.06+Math.random()*0.04 });
    }
    const rMax=(6+Math.random()*10)*DPR*(0.6+strength*0.8);
    this.ripples.push({ x, y:this.floorYpx, r:2, rMax, alpha:0.35, fade:0.015+Math.random()*0.01, width:1.2*DPR });
  }
  update(){ for (let j of this.jets){ j.vy+=0.25*DPR; j.x+=j.vx+gust.val*0.15; j.y+=j.vy; j.life-=j.decay; }
    this.jets=this.jets.filter(j=>j.life>0 && j.y<this.floorYpx+4*DPR);
    for (let r of this.ripples){ r.r+=0.9*DPR; r.alpha-=r.fade; }
    this.ripples=this.ripples.filter(r=>r.alpha>0 && r.r<r.rMax);
  }
  draw(){ if (this.jets.length){ ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.globalAlpha=0.7; ctx.fillStyle='rgba(190,210,255,.65)';
      for (let j of this.jets){ ctx.beginPath(); ctx.arc(j.x,j.y,1.2*DPR,0,Math.PI*2); ctx.fill(); } ctx.restore(); }
    if (this.ripples.length){ ctx.save(); ctx.strokeStyle='rgba(200,220,255,0.5)';
      for (let r of this.ripples){ ctx.globalAlpha=r.alpha; ctx.lineWidth=r.width; ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,Math.PI*2); ctx.stroke(); } ctx.restore(); } }
}

/* Rain */
class RainSystem {
  constructor(){ this.drops=[]; this.intensity=0; this.floorYpx=fx.height*0.92; this.enabled=false; this.splashes=new SplashSystem(); }
  setEnabled(on){ this.enabled=on; } setSplashes(on){ this.splashes.setEnabled(on); }
  setFloorY(yPx){ this.floorYpx=yPx; this.splashes.setFloorY(yPx); }
  setIntensity(f){ this.intensity=clamp01(f); }
  spawnOne(layer=1){ const W=fx.width, H=fx.height;
    const x=Math.random()*(W+100*DPR)-50*DPR; const y=-Math.random()*H*0.15;
    const vy=[10,14,19][layer]*DPR + Math.random()*[5,6,7][layer]*DPR;
    const slope=0.25+Math.random()*0.25; const vx=slope*vy;
    const w=[0.7,1.0,1.4][layer]*DPR; const alpha=[0.35,0.55,0.8][layer];
    this.drops.push({x,y,vx,vy,w,alpha,layer}); }
  ensureCount(){ const target=Math.floor(this.intensity*900);
    while(this.drops.length<target){ const r=Math.random(); const layer=r<0.2?2:(r<0.75?1:0); this.spawnOne(layer); }
    if(this.drops.length>target) this.drops.length=target; }
  update(){ if(!this.enabled || this.intensity<=0) return; this.ensureCount();
    const W=fx.width, H=fx.height;
    for(let d of this.drops){ d.x+=d.vx+gust.val*(0.25+d.layer*0.25); d.y+=d.vy;
      if(d.y>=this.floorYpx){ this.splashes.spawn(d.x,0.7+d.layer*0.3); d.y=-Math.random()*H*0.2; d.x=Math.random()*(W+100*DPR)-50*DPR; }
      if(d.x<-60*DPR) d.x=W+60*DPR; if(d.x>W+60*DPR) d.x=-60*DPR; }
    this.splashes.update(); }
  draw(){ if(!this.enabled || this.intensity<=0) return;
    ctx.save(); ctx.lineCap='round';
    for(let pass=0; pass<3; pass++){ for(let d of this.drops){ if(d.layer!==pass) continue;
      ctx.globalAlpha=d.alpha; ctx.strokeStyle='#bcd7ff'; ctx.lineWidth=d.w; ctx.beginPath();
      ctx.moveTo(d.x,d.y); ctx.lineTo(d.x-(d.vx+gust.val*0.2)*0.5, d.y-d.vy*0.5); ctx.stroke(); } }
    ctx.restore(); this.splashes.draw(); }
}

/* Snow */
function makeFlakeSprite(r){ const c=document.createElement('canvas'); c.width=c.height=Math.ceil(r*2+2);
  const g=c.getContext('2d'); const cx=c.width/2, cy=c.height/2;
  const grd=g.createRadialGradient(cx,cy,0,cx,cy,r);
  grd.addColorStop(0,'rgba(255,255,255,.95)'); grd.addColorStop(0.6,'rgba(255,255,255,.55)'); grd.addColorStop(1,'rgba(255,255,255,0)');
  g.fillStyle=grd; g.beginPath(); g.arc(cx,cy,r,0,Math.PI*2); g.fill(); return c; }
const SNOW_SPRITES=[makeFlakeSprite(1.2*DPR),makeFlakeSprite(1.8*DPR),makeFlakeSprite(2.4*DPR)];
class SnowSystem{
  constructor(){ this.flakes=[]; this.intensity=0; this.enabled=false; }
  setEnabled(on){ this.enabled=on; } setIntensity(f){ this.intensity=clamp01(f); }
  ensureCount(){ const target=Math.floor(this.intensity*420); while(this.flakes.length<target) this.spawn(); if(this.flakes.length>target) this.flakes.length=target; }
  spawn(){ const W=fx.width,H=fx.height; const z=Math.random(); const idx=(z<0.33?0:(z<0.66?1:2));
    const vx=(Math.random()*0.3-0.15)*DPR; const vy=(0.4+Math.random()*0.6)*(0.6+z*0.8)*DPR;
    this.flakes.push({ x:Math.random()*W, y:-Math.random()*H*0.2, vx, vy, swing:(0.4+Math.random()*1.6)*DPR, t:Math.random()*Math.PI*2, tw:0.008+Math.random()*0.02,
      z, s:SNOW_SPRITES[idx], alpha:0.6+(1-z)*0.35 }); }
  update(){ if(!this.enabled||this.intensity<=0) return; this.ensureCount(); const W=fx.width,H=fx.height;
    for(let f of this.flakes){ f.t+=f.tw; const sway=Math.sin(f.t)*f.swing; f.x+=f.vx+sway*0.02+gust.val*0.12*(0.5+f.z); f.y+=f.vy;
      if(f.y>H){ f.y=-10*DPR; f.x=Math.random()*W; } if(f.x<-50*DPR) f.x=W+50*DPR; if(f.x>W+50*DPR) f.x=-50*DPR; } }
  draw(){ if(!this.enabled||this.intensity<=0) return; ctx.save(); for(let f of this.flakes){ ctx.globalAlpha=f.alpha; ctx.drawImage(f.s,f.x-f.s.width/2,f.y-f.s.height/2); } ctx.restore(); }
}

/* Leaves (autumn) */
class LeafSystem{
  constructor(){ this.enabled=false; this.intensity=0; this.leaves=[]; this.sprites=[]; this.ready=false; this.fallbackColors=['#c55c18','#d79a2e','#9a5a1a','#bf6f24']; }
  async load(urls){ const loads=urls.map(u=>new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>res(null); img.src=u; }));
    const imgs=await Promise.all(loads); this.sprites=imgs.filter(Boolean); this.ready=this.sprites.length>0; }
  setEnabled(on){ this.enabled=on; } setIntensity(f){ this.intensity=clamp01(f); }
  ensureCount(){ const target=Math.floor(this.intensity*180); while(this.leaves.length<target) this.spawn(); if(this.leaves.length>target) this.leaves.length=target; }
  spawn(){ const W=fx.width,H=fx.height; const scale=0.6+Math.random()*0.9; const vx=(Math.random()*0.6+0.3)*DPR; const vy=(0.8+Math.random()*1.4)*DPR;
    const rot=Math.random()*Math.PI*2, rotSpd=(Math.random()*0.02 - 0.01);
    const sprite=this.ready?this.sprites[Math.floor(Math.random()*this.sprites.length)]:null;
    const color=this.fallbackColors[Math.floor(Math.random()*this.fallbackColors.length)];
    this.leaves.push({ x:-20*DPR+Math.random()*W, y:-Math.random()*H*0.3, vx, vy, rot, rotSpd, scale, sprite, color }); }
  update(){ if(!this.enabled||this.intensity<=0) return; this.ensureCount(); const W=fx.width,H=fx.height;
    for(let L of this.leaves){ L.x+=L.vx+gust.val*0.35; L.y+=L.vy*(0.6+0.4*Math.sin(L.rot*2)); L.rot+=L.rotSpd+0.006*Math.sin(L.x*0.01);
      if(L.y>H+30*DPR){ L.y=-20*DPR; L.x=Math.random()*W; } if(L.x>W+30*DPR) L.x=-30*DPR; } }
  draw(){ if(!this.enabled||this.intensity<=0) return; ctx.save();
    for(let L of this.leaves){ ctx.translate(L.x,L.y); ctx.rotate(L.rot); ctx.scale(L.scale,L.scale);
      if(L.sprite){ const w=L.sprite.width,h=L.sprite.height; ctx.globalAlpha=0.9; ctx.drawImage(L.sprite, -w/2, -h/2); }
      else { ctx.fillStyle=L.color; ctx.globalAlpha=0.85; ctx.beginPath(); ctx.moveTo(0,-8*DPR); ctx.quadraticCurveTo(10*DPR,0,0,8*DPR); ctx.quadraticCurveTo(-10*DPR,0,0,-8*DPR); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=0.8*DPR; ctx.stroke(); }
      ctx.setTransform(1,0,0,1,0,0); }
    ctx.restore(); }
}
const leafFX = new LeafSystem();
leafFX.load(["sprites/leaves/leaf1.png","sprites/leaves/leaf2.png","sprites/leaves/leaf3.png"]).catch(()=>{});

/* Render loop */
const rainFX = new RainSystem(); const snowFX = new SnowSystem();
let running=true;
function loop(){ if(!running) return; ctx.clearRect(0,0,fx.width,fx.height);
  updateGust(document.getElementById('windOn').checked);
  rainFX.update(); snowFX.update(); leafFX.update();
  rainFX.draw();   snowFX.draw();   leafFX.draw();
  windowTrails.forEach(w => w.updateDraw());
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===================== FIRE SPRITE ===================== */
class FireSprite{ constructor(el){ this.el=el; this.cfg=null; this.frame=0; this.timer=null; this.total=0; }
  load(cfg){ this.cfg=cfg; this.frame=0; this.total=cfg.cols*cfg.rows; this.el.style.backgroundImage=`url('${cfg.url}')`;
    this.el.style.width=cfg.frameW+'px'; this.el.style.height=cfg.frameH+'px'; this.el.style.backgroundSize=`${cfg.cols*100}% ${cfg.rows*100}%`; }
  place(px,py,scale=1){ this.el.style.left=px+'px'; this.el.style.top=py+'px'; this.el.style.transform=`translate(-50%,-50%) scale(${scale})`; }
  start(){ if(!this.cfg) return; this.el.style.display='block';
    const step=()=>{ this.frame=(this.frame+1)%this.total; const c=this.frame%this.cfg.cols, r=Math.floor(this.frame/this.cfg.cols);
      const posX=(c/(this.cfg.cols-1))*100, posY=(r/(this.cfg.rows-1))*100; this.el.style.backgroundPosition=`${posX}% ${posY}%`;
      this.timer=setTimeout(step, 1000/this.cfg.fps); }; step(); }
  stop(){ this.el.style.display='none'; if(this.timer){ clearTimeout(this.timer); this.timer=null; } } }
const fireSprite = new FireSprite(document.getElementById('fire-sprite'));

/* ===================== PROPS (LAMP / WINDOW) ===================== */
const overlaysEl = document.getElementById('overlays'); const windowTrails = [];
function pctBoxToPx(box){ const vw=window.innerWidth, vh=window.innerHeight; return { left:vw*(box.x/100), top:vh*(box.y/100), width:vw*(box.w/100), height:vh*(box.h/100) }; }
function makeLampGlow(box, color="rgba(255,210,140,0.9)", radius=320){
  const px = pctBoxToPx(box); const d = document.createElement('div'); d.className = 'lamp-glow';
  const cx = px.left + px.width/2, cy = px.top + px.height/2; d.style.left = cx + 'px'; d.style.top = cy + 'px';
  d.style.width = radius + 'px'; d.style.height = radius + 'px';
  d.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,200,120,0.6) 35%, rgba(255,160,80,0.18) 65%, rgba(255,120,60,0.05) 100%)`;
  overlaysEl.appendChild(d);
  return { el: d, resize(){ const px=pctBoxToPx(box); const cx=px.left+px.width/2, cy=px.top+px.height/2; d.style.left=cx+'px'; d.style.top=cy+'px'; } };
}
class WindowTrail { constructor(boxPct){ this.boxPct=boxPct; this.canvas=null; this.ctx=null; this.streams=[]; this.active=false; }
  attach(){ const px=pctBoxToPx(this.boxPct); const c=document.createElement('canvas'); c.className='window-overlay';
    c.style.left=px.left+'px'; c.style.top=px.top+'px'; c.width=Math.max(1, Math.floor(px.width*DPR)); c.height=Math.max(1, Math.floor(px.height*DPR));
    c.style.width=px.width+'px'; c.style.height=px.height+'px'; overlaysEl.appendChild(c); this.canvas=c; this.ctx=c.getContext('2d'); this.active=true; this.buildStreams(); }
  detach(){ if(this.canvas){ this.canvas.remove(); this.canvas=null; this.ctx=null; } this.active=false; }
  resize(){ if(!this.canvas) return; const px=pctBoxToPx(this.boxPct);
    this.canvas.style.left=px.left+'px'; this.canvas.style.top=px.top+'px';
    this.canvas.width=Math.max(1, Math.floor(px.width*DPR)); this.canvas.height=Math.max(1, Math.floor(px.height*DPR));
    this.canvas.style.width=px.width+'px'; this.canvas.style.height=px.height+'px'; this.buildStreams(); }
  buildStreams(){ if(!this.ctx) return; this.streams=[]; const W=this.canvas.width,H=this.canvas.height;
    const count=Math.max(4, Math.floor(W/70)); for(let i=0;i<count;i++){ this.streams.push({ x:Math.random()*W, y:Math.random()*H*0.2, speed:(0.6+Math.random()*1.2)*DPR,
      len:(H*0.25)+Math.random()*H*0.35, w:(0.8+Math.random()*1.4)*DPR, alpha:0.25+Math.random()*0.25 }); } }
  updateDraw(){ if(!this.active||!this.ctx) return; const W=this.canvas.width,H=this.canvas.height,g=this.ctx;
    g.globalCompositeOperation='destination-out'; g.fillStyle='rgba(0,0,0,0.08)'; g.fillRect(0,0,W,H);
    g.globalCompositeOperation='source-over';
    for(let s of this.streams){ s.y+=s.speed+Math.max(0, gust.val*0.15); if(s.y-s.len>H){ s.y=-Math.random()*H*0.1; s.x=Math.random()*W; }
      const grad=g.createLinearGradient(s.x, s.y-s.len, s.x, s.y); grad.addColorStop(0,'rgba(200,220,255,0)'); grad.addColorStop(1,`rgba(200,220,255,${s.alpha})`);
      g.strokeStyle=grad; g.lineWidth=s.w; g.beginPath(); g.moveTo(s.x, s.y-s.len); g.lineTo(s.x, s.y); g.stroke(); } } }

/* ===================== UI & STATE ===================== */
const $ = s => document.querySelector(s);
const sceneEl = $('#scene'), bgScaleEl = $('#bgScale'), baseImg = $('#baseImg');
const hotspotsEl = $('#hotspots'), seasonPicker = $('#season-picker'), loader = $('#loader'), controls = $('#controls');
const changeSeasonBtn = $('#changeSeasonBtn'), toggleControlsBtn = $('#toggleControlsBtn'), muteBtn = $('#muteBtn'), hotspotDebugBtn = $('#hotspotDebugBtn');
const elementsPanel = $('#elementsPanel'), elementsList = $('#elementsList');

const rainOn = $('#rainOn'), snowOn=$('#snowOn'), windOn=$('#windOn'), splashesOn=$('#splashesOn'), fireOn=$('#fireOn'), leavesOn=$('#leavesOn');
const rainIntensity = $('#rainIntensity'), snowIntensity=$('#snowIntensity'), leavesIntensity=$('#leavesIntensity');
const masterVol = $('#masterVol'), rainVol=$('#rainVol'), fireVol=$('#fireVol'), windVol=$('#windVol'), birdsVol=$('#birdsVol');
const brightness = $('#brightness'), warmth=$('#warmth'), vignette=$('#vignette'); const cycleOn = $('#cycleOn');
const fireChip = $('#fireChip');

const rainChipEl = $('#rainChip'), snowChipEl = $('#snowChip'), splashesChipEl = $('#splashesChip'), leavesChipEl = $('#leavesChip');
const rainWrapEl = $('#rainWrap'), snowWrapEl = $('#snowWrap'), leavesWrapEl = $('#leavesWrap');

let currentSeasonKey=null, currentCfg=null, fireplaceBounds=null, hotspotDebug=false;
let overlayState = {};          // {key:boolean}
let overlayImgs  = {};          // {key: HTMLImageElement}
const STORE_KEY='ambience.settings.v3';

function saveSettings(){
  try{
    const overlays = {};
    elementsList.querySelectorAll('input[data-overlay]').forEach(inp => overlays[inp.dataset.overlay] = !!inp.checked);
    localStorage.setItem(STORE_KEY, JSON.stringify({
      season: currentSeasonKey,
      rainOn: rainOn.checked, snowOn: snowOn.checked, windOn: windOn.checked, splashesOn: splashesOn.checked, fireOn: fireOn?.checked, leavesOn: leavesOn.checked,
      rainIntensity:+rainIntensity.value/100, snowIntensity:+snowIntensity.value/100, leavesIntensity:+leavesIntensity.value/100,
      volumes:{ master:+masterVol.value/100, rain:+rainVol.value/100, fire:+fireVol.value/100, wind:+windVol.value/100, birds:+birdsVol.value/100 },
      visuals:{ brightness:+brightness.value/100, warmth:+warmth.value/100, vignette:+vignette.value/100, cycleOn:cycleOn.checked },
      overlays, muted:globalMuted
    }));
  } catch{}
}
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)); }catch{return null;} }
function showLoader(flag){ loader.style.display = flag ? 'grid' : 'none'; }
function show(el, on) { if (!el) return; el.style.display = on ? '' : 'none'; }

/* ------- Overlays (Picnic) as real <img> with fade ------- */
function clearOverlayImages(){ Object.values(overlayImgs).forEach(img => img.remove()); overlayImgs = {}; }
function ensureOverlayImage(def){
  if (overlayImgs[def.key]) return overlayImgs[def.key];
  const img = new Image(); img.className = 'bg-img bg-overlay'; img.alt = def.label || def.key; img.src = def.url;
  bgScaleEl.appendChild(img); overlayImgs[def.key] = img; return img;
}
function syncOverlayImages(){
  const defs = currentCfg.overlays || [];
  // ensure desired visibilities
  defs.forEach(def=>{
    const want = !!overlayState[def.key];
    const img = ensureOverlayImage(def);
    // quick fade via class toggle; image loads asynchronously but opacity anim still applies when it flips to "on"
    if (want) img.classList.add('on'); else img.classList.remove('on');
  });
  // hide controls panel if none
  elementsPanel.style.display = defs.length ? '' : 'none';
}
function buildOverlayControls(){
  elementsList.innerHTML = '';
  clearOverlayImages();
  const defs = currentCfg.overlays || [];
  if (!defs.length){ overlayState = {}; elementsPanel.style.display='none'; return; }
  overlayState = Object.fromEntries(defs.map(d => [d.key, !!d.default]));
  const saved = loadSettings(); if (saved && saved.season===currentSeasonKey && saved.overlays){ for (const k in saved.overlays) if (k in overlayState) overlayState[k]=!!saved.overlays[k]; }
  defs.forEach(d=>{
    const span = document.createElement('span'); span.className='chip'; const id=`overlay-${d.key}`;
    span.innerHTML = `<input type="checkbox" id="${id}" data-overlay="${d.key}" ${overlayState[d.key]?'checked':''}><span class="lbl">${d.label}</span>`;
    elementsList.appendChild(span);
  });
  elementsPanel.style.display='';
  // wire
  elementsList.querySelectorAll('input[data-overlay]').forEach(inp=>{
    inp.addEventListener('change', ()=>{ overlayState[inp.dataset.overlay] = inp.checked; syncOverlayImages(); saveSettings(); });
  });
  // apply
  syncOverlayImages();
}

/* ------- Weather controls visibility ------- */
function updateVisibilityForSeason() {
  const allow = currentCfg?.allow || { rain:true, snow:true, leaves:(currentSeasonKey==='fall') };
  show(rainChipEl,     allow.rain); show(rainWrapEl, allow.rain); show(splashesChipEl, allow.rain);
  show(snowChipEl, allow.snow); show(snowWrapEl, allow.snow);
  const leavesAllowed = !!(allow.leaves && currentSeasonKey==='fall'); show(leavesChipEl, leavesAllowed); show(leavesWrapEl, leavesAllowed);
}
function enforceSeasonConstraints() {
  const allow = currentCfg?.allow || {};
  if (!allow.rain) { rainOn.checked=false; rainFX.setEnabled(false); rainFX.setIntensity(0); setTrackVolume('rain',0); }
  if (!allow.snow) { snowOn.checked=false; snowFX.setEnabled(false); snowFX.setIntensity(0); }
  if (!(allow.leaves && currentSeasonKey==='fall')) { leavesOn.checked=false; leafFX.setEnabled(false); leafFX.setIntensity(0); }
}

/* ------- Season load ------- */
async function loadSeason(key){
  currentSeasonKey = key; currentCfg = SCENES[key]; showLoader(true);
  // preload base, then set it
  await new Promise(res=>{ const i=new Image(); i.onload=res; i.onerror=res; i.src=currentCfg.image; });
  baseImg.src = currentCfg.image;
  sceneEl.setAttribute('aria-label', `${currentCfg.name} ambience background`);

  // reset overlays (canvases)
  overlaysEl.innerHTML=''; windowTrails.splice(0, windowTrails.length);

  // build overlay chips (e.g., Picnic) and actual <img> layers
  buildOverlayControls();

  // hotspots reset
  hotspotsEl.innerHTML=''; fireplaceBounds=null;
  if(currentCfg.hasFireplace && currentCfg.fireHotspot){
    const hot=document.createElement('button'); hot.className='hotspot'; hot.title='Toggle fireplace'; hot.setAttribute('aria-label','Toggle fireplace');
    hotspotsEl.appendChild(hot); positionHotspot(hot, currentCfg.fireHotspot); hot.addEventListener('click', ()=> toggleFire());
    if (hotspotDebug) hot.classList.add('debug');
    fireplaceBounds = pctBoxToPx(currentCfg.fireHotspot);
    if (currentCfg.fireSprite) fireSprite.load(currentCfg.fireSprite); placeFireSprite();
    fireChip.style.display=''; if (fireOn) fireOn.checked = currentCfg.defaults.fireOn;
  } else { fireChip.style.display='none'; if (fireOn){ fireOn.checked=false; } fireSprite.stop(); }

  // Props hotspots (lamps/windows)
  (currentCfg.props||[]).forEach(p=>{
    const hot=document.createElement('button'); hot.className='hotspot';
    hot.title = p.type==='lamp' ? 'Toggle lamp' : 'Toggle window rain trails';
    hotspotsEl.appendChild(hot); positionHotspot(hot, p.box);
    if (hotspotDebug) hot.classList.add('debug');
    if (p.type==='lamp'){ let lamp=null; let on=false;
      hot.addEventListener('click', ()=>{ on=!on; if(on){ lamp=makeLampGlow(p.box, p.color||"rgba(255,210,140,0.9)", p.radius||320); } else { lamp?.el.remove(); lamp=null; } });
      window.addEventListener('resize', ()=>{ if(lamp) lamp.resize(); });
    } else if (p.type==='window'){ const wt=new WindowTrail(p.box); let on=false;
      hot.addEventListener('click', ()=>{ on=!on; if(on){ wt.attach(); windowTrails.push(wt); } else { wt.detach(); const i=windowTrails.indexOf(wt); if(i>-1) windowTrails.splice(i,1); } });
      window.addEventListener('resize', ()=>{ wt.resize(); });
    }
  });

  // Defaults + saved
  const saved = loadSettings(); const def = currentCfg.defaults; const v = (saved && saved.season===key) ? saved : null;
  rainOn.checked  = v ? v.rainOn  : def.rainOn;
  snowOn.checked  = v ? v.snowOn  : def.snowOn;
  windOn.checked  = v ? v.windOn  : def.windOn;
  splashesOn.checked = v ? v.splashesOn : def.splashesOn;
  leavesOn.checked = v ? v.leavesOn : def.leavesOn;
  if (fireOn) fireOn.checked = v ? !!v.fireOn : def.fireOn;

  rainIntensity.value = Math.round(100*(v ? v.rainIntensity : def.rainIntensity));
  snowIntensity.value = Math.round(100*(v ? v.snowIntensity : def.snowIntensity));
  leavesIntensity.value= Math.round(100*(v ? v.leavesIntensity : def.leavesIntensity));

  masterVol.value = Math.round(100*(v ? v.volumes.master : def.volumes.master));
  rainVol.value   = Math.round(100*(v ? v.volumes.rain   : def.volumes.rain));
  fireVol.value   = Math.round(100*(v ? v.volumes.fire   : def.volumes.fire));
  windVol.value   = Math.round(100*(v ? v.volumes.wind   : def.volumes.wind));
  birdsVol.value  = Math.round(100*(v ? v.volumes.birds  : def.volumes.birds));

  brightness.value = Math.round(100*(v ? v.visuals.brightness : def.visuals.brightness));
  warmth.value     = Math.round(100*(v ? v.visuals.warmth     : def.visuals.warmth));
  vignette.value   = Math.round(100*(v ? v.visuals.vignette   : def.visuals.vignette));
  cycleOn.checked  = v ? !!v.visuals.cycleOn : def.visuals.cycleOn;

  globalMuted = v ? !!v.muted : false; updateMuteButton();

  // Weather floor & systems
  const floorPx = fx.height * (currentCfg.floorY/100);
  rainFX.setFloorY(floorPx); rainFX.setSplashes(splashesOn.checked);
  snowFX.setEnabled(snowOn.checked); rainFX.setEnabled(rainOn.checked);

  updateVisibilityForSeason(); enforceSeasonConstraints();

  // Leaves only in Fall
  leafFX.setEnabled(leavesOn.checked && currentSeasonKey==='fall');

  applyWeather(); applyVolumes(); applyVisuals();
  if (fireOn?.checked && currentCfg.hasFireplace) lightFire(); else extinguishFire();

  showLoader(false);
  controls.style.display='grid';
  seasonPicker.style.display='none';
}

function positionHotspot(el, pct){ const r=pctBoxToPx(pct);
  el.style.left=r.left+'px'; el.style.top=r.top+'px'; el.style.width=r.width+'px'; el.style.height=r.height+'px'; }
function placeFireSprite(){ if(!fireplaceBounds || !currentCfg?.fireSprite) return;
  const {left,top,width,height}=fireplaceBounds;
  const cx=left+width/2+(currentCfg.fireSprite.offsetX||0), cy=top+height/2+(currentCfg.fireSprite.offsetY||0);
  fireSprite.place(cx,cy,currentCfg.fireSprite.scale||1);
}

/* ------- Weather/Audio/Visuals ------- */
function applyWeather(){
  const allow = currentCfg?.allow || { rain:true, snow:true, leaves:(currentSeasonKey==='fall') };
  const rainAllowed=!!allow.rain, snowAllowed=!!allow.snow, leavesAllowed=!!(allow.leaves && currentSeasonKey==='fall');

  const rainEnabled = rainAllowed && rainOn.checked; rainFX.setEnabled(rainEnabled);
  rainFX.setIntensity(rainEnabled ? (+rainIntensity.value/100) : 0);
  rainFX.setSplashes(rainEnabled && splashesOn.checked);

  const snowEnabled = snowAllowed && snowOn.checked; snowFX.setEnabled(snowEnabled);
  snowFX.setIntensity(snowEnabled ? (+snowIntensity.value/100) : 0);

  const leavesEnabled=leavesAllowed && leavesOn.checked; leafFX.setEnabled(leavesEnabled);
  leafFX.setIntensity(leavesEnabled ? (+leavesIntensity.value/100) : 0);

  setTrackVolume('wind', windOn.checked ? (+windVol.value/100) : 0);
  setTrackVolume('rain', (rainEnabled ? (+rainVol.value/100) : 0) * Math.max(.25, +rainIntensity.value/100));
  saveSettings();
}
function applyVolumes(){
  masterVolume = +masterVol.value/100;
  const allow = currentCfg?.allow || {};
  const rainEnabled = !!allow.rain && rainOn.checked;
  setTrackVolume('rain', (rainEnabled ? +rainVol.value/100 : 0) * Math.max(.25, +rainIntensity.value/100));
  setTrackVolume('fire',  fireOn?.checked ? +fireVol.value/100 : 0);
  setTrackVolume('wind',  windOn.checked ? +windVol.value/100 : 0);
  setTrackVolume('birds', +birdsVol.value/100 * birdsCycleMultiplier);
  saveSettings();
}
let cycleTimer=null, birdsCycleMultiplier=1;
function applyVisuals(){
  const baseB=+brightness.value/100, baseW=+warmth.value/100, baseV=+vignette.value/100;
  const c = cycleOn.checked ? computeDayCycle() : { bMul:1, wAdd:0, vAdd:0, birdsMul:1 }; birdsCycleMultiplier=c.birdsMul;
  const sepia=Math.max(0,(baseW+c.wAdd))*0.6; const hue=((baseW+c.wAdd)<0?-6:6)*Math.abs(baseW+c.wAdd); const sat=1+Math.abs(baseW+c.wAdd)*0.25;
  sceneEl.style.filter = `brightness(${baseB*c.bMul}) saturate(${sat}) sepia(${sepia}) hue-rotate(${hue}deg)`;
  sceneEl.style.setProperty('--vignette', baseV + c.vAdd);
  setTrackVolume('birds', +birdsVol.value/100 * birdsCycleMultiplier);
  saveSettings();
}
function computeDayCycle(){
  const now=new Date(); const minutes=now.getHours()*60+now.getMinutes(); const t=minutes/1440;
  const day=0.5-0.5*Math.cos(2*Math.PI*t);
  const gauss=(x,mu,s)=>Math.exp(-((x-mu)*(x-mu))/(2*s*s));
  const golden = gauss(t,0.25,0.035) + gauss(t,0.75,0.035);
  const bMul=0.65+0.45*day, wAdd=0.18*golden-0.08*(1-day), vAdd=0.08*(1-day);
  const birdsMul=Math.max(0, Math.min(1, 0.15 + 0.9*day + 0.35*golden));
  return { bMul, wAdd, vAdd, birdsMul };
}
function startDayCycle(){ if (cycleTimer) clearInterval(cycleTimer); cycleTimer=setInterval(applyVisuals, 30*1000); applyVisuals(); }

/* ------- Fireplace ------- */
function lightFire(){ if(!currentCfg || !currentCfg.hasFireplace) return;
  if (currentCfg.fireSprite) fireSprite.start(); setTrackVolume('fire', +fireVol.value/100); fireOn && (fireOn.checked=true); saveSettings(); }
function extinguishFire(){ fireSprite.stop(); setTrackVolume('fire',0); fireOn && (fireOn.checked=false); saveSettings(); }
function toggleFire(){ fireOn.checked ? extinguishFire() : lightFire(); }

/* ------- Mute & helpers ------- */
function updateMuteButton(){ muteBtn.textContent = globalMuted ? 'üîä Unmute' : 'üîá Mute'; applyVolumes(); }
function toggleMute(){ globalMuted = !globalMuted; updateMuteButton(); saveSettings(); }

/* ------- Wiring ------- */
document.querySelectorAll('.season-card').forEach(btn=>{
  btn.addEventListener('click', ()=>{ unlockAudio(); loadSeason(btn.dataset.season); });
});
changeSeasonBtn.addEventListener('click', ()=>{ seasonPicker.style.display='grid'; controls.style.display='none'; });
toggleControlsBtn.addEventListener('click', ()=>{ controls.style.display = (controls.style.display==='none' || !controls.style.display) ? 'grid' : 'none'; });
muteBtn.addEventListener('click', toggleMute);
hotspotDebugBtn.addEventListener('click', ()=>{
  hotspotDebug = !hotspotDebug;
  document.querySelectorAll('.hotspot').forEach(h => hotspotDebug ? h.classList.add('debug') : h.classList.remove('debug'));
});

[rainOn, snowOn, windOn, splashesOn, leavesOn].forEach(el=> el.addEventListener('change', applyWeather));
[rainIntensity, snowIntensity, leavesIntensity].forEach(el=> el.addEventListener('input', applyWeather));
[masterVol, rainVol, fireVol, windVol, birdsVol].forEach(el=> el.addEventListener('input', applyVolumes));
[brightness, warmth, vignette, cycleOn].forEach(el=> el.addEventListener('input', applyVisuals));
if (fireOn) fireOn.addEventListener('change', ()=> fireOn.checked ? lightFire() : extinguishFire());

window.addEventListener('keydown', (e)=>{
  if (e.key==='m' || e.key==='M') toggleMute();
  if (e.key==='c' || e.key==='C') { controls.style.display = (controls.style.display==='none'||!controls.style.display) ? 'grid' : 'none'; }
  if (e.key==='s' || e.key==='S') { changeSeasonBtn.click(); }
  if (e.key==='h' || e.key==='H') { hotspotDebugBtn.click(); }
});

window.addEventListener('resize', ()=>{
  if (currentCfg?.fireHotspot){
    const hot=document.querySelector('.hotspot'); if(hot) positionHotspot(hot, currentCfg.fireHotspot);
    fireplaceBounds = pctBoxToPx(currentCfg.fireHotspot); placeFireSprite();
  }
  document.querySelectorAll('.window-overlay').forEach((_,i)=> windowTrails[i]?.resize());
  if (currentCfg){ const floorPx = fx.height * (currentCfg.floorY/100); rainFX.setFloorY(floorPx); }
});

/* Show picker first & start day cycle */
seasonPicker.style.display='grid'; controls.style.display='none';
startDayCycle();
</script>
</body>
</html>
